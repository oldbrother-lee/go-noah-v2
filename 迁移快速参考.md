# goInsight 到 go-noah 迁移快速参考

## 一、代码模式对照表

### 1.1 全局变量 → 全局变量（新架构）

| goInsight | go-noah |
|-----------|---------|
| `global.App.DB` | `global.DB` |
| `global.App.Redis` | `global.Redis`（如需要） |
| `global.App.Log` | `global.Logger` |
| `global.App.Config` | `conf`（通过参数传递） |
| `global.App.JWT` | `global.JWT` |

### 1.2 函数调用模式

**goInsight:**
```go
// Views 层
func GetUsers(c *gin.Context) {
    service := services.GetUsersService{
        C:        c,
        Username: c.GetString("username"),
    }
    service.Run()
}

// Services 层
func (s *GetUsersService) Run() {
    var users []models.InsightUsers
    global.App.DB.Find(&users)
    // ...
}
```

**go-noah:**
```go
// Handler 层（全局变量）
type UserHandler struct{}

var UserHandlerApp = new(UserHandler)

func (h *UserHandler) GetUsers(ctx *gin.Context) {
    page, _ := strconv.Atoi(ctx.DefaultQuery("page", "1"))
    pageSize, _ := strconv.Atoi(ctx.DefaultQuery("page_size", "10"))
    users, total, err := service.UserServiceApp.GetUsers(ctx.Request.Context(), page, pageSize)
    v1.HandleSuccess(ctx, gin.H{"list": users, "total": total})
}

// Service 层（全局变量）
type UserService struct{}

var UserServiceApp = new(UserService)

func (s *UserService) GetUsers(ctx context.Context, page, pageSize int) ([]*model.User, int64, error) {
    repo := repository.NewUserRepository(global.Repo)
    return repo.GetUsers(ctx, page, pageSize)
}

// Repository 层
func (r *UserRepository) GetUsers(ctx context.Context, page, pageSize int) ([]*model.User, int64, error) {
    var users []*model.User
    var total int64
    offset := (page - 1) * pageSize
    r.db.WithContext(ctx).Model(&model.User{}).Count(&total)
    r.db.WithContext(ctx).Offset(offset).Limit(pageSize).Find(&users)
    return users, total, nil
}
```

## 二、常用代码片段

### 2.1 数据库查询

**goInsight:**
```go
var users []models.InsightUsers
global.App.DB.Where("username = ?", username).First(&user)
global.App.DB.Find(&users)
global.App.DB.Create(&user)
global.App.DB.Save(&user)
global.App.DB.Delete(&user)
```

**go-noah:**
```go
// 在 Repository 中
func (r *UserRepository) GetUserByUsername(ctx context.Context, username string) (*model.User, error) {
    var user model.User
    err := global.DB.WithContext(ctx).Where("username = ?", username).First(&user).Error
    return &user, err
}

func (r *UserRepository) CreateUser(ctx context.Context, user *model.User) error {
    return global.DB.WithContext(ctx).Create(user).Error
}
```

### 2.2 Redis 操作

**goInsight:**
```go
global.App.Redis.Set(ctx, key, value, 0)
global.App.Redis.Get(ctx, key)
global.App.Redis.Del(ctx, key)
```

**go-noah:**
```go
// 在 Service 中直接使用 global.Redis（如需要）
func (s *UserService) SetCache(ctx context.Context, key, value string) error {
    return global.Redis.Set(ctx, key, value, 0).Err()
}
```

### 2.3 日志记录

**goInsight:**
```go
global.App.Log.Info("message")
global.App.Log.Error("error", err)
global.App.Log.WithFields(logrus.Fields{
    "key": "value",
}).Info("message")
```

**go-noah:**
```go
global.Logger.Info("message", zap.String("key", "value"))
global.Logger.Error("error", zap.Error(err))
global.Logger.Debug("debug message", zap.Int("count", 10))
```

### 2.4 错误处理

**goInsight:**
```go
c.JSON(http.StatusOK, gin.H{
    "code": 200,
    "msg":  "success",
    "data": data,
})

c.JSON(http.StatusBadRequest, gin.H{
    "code": 400,
    "msg":  err.Error(),
})
```

**go-noah:**
```go
v1.HandleSuccess(ctx, data)
v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, nil)
```

### 2.5 参数验证

**goInsight:**
```go
type GetUsersForm struct {
    Page     int `form:"page" json:"page"`
    PageSize int `form:"page_size" json:"page_size"`
}

var form GetUsersForm
if err := c.ShouldBindQuery(&form); err != nil {
    // handle error
}
```

**go-noah:**
```go
type GetUsersRequest struct {
    Page     int `form:"page" json:"page" binding:"required"`
    PageSize int `form:"page_size" json:"page_size" binding:"required"`
}

var req GetUsersRequest
if err := ctx.ShouldBindQuery(&req); err != nil {
    v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, nil)
    return
}
```

### 2.6 事务处理

**goInsight:**
```go
tx := global.App.DB.Begin()
// ... operations
tx.Commit()
// or
tx.Rollback()
```

**go-noah:**
```go
// 在 Service 中使用 Transaction
func (s *UserService) CreateUserWithRole(ctx context.Context, user *model.User, role *model.Role) error {
    return global.Transaction.Transaction(ctx, func(ctx context.Context) error {
        repo := repository.NewUserRepository(global.Repo)
        if err := repo.CreateUser(ctx, user); err != nil {
            return err
        }
        roleRepo := repository.NewRoleRepository(global.Repo)
        if err := roleRepo.CreateRole(ctx, role); err != nil {
            return err
        }
        return nil
    })
}
```

## 三、目录结构映射

### 3.1 文件位置映射

| goInsight | go-noah |
|-----------|---------|
| `internal/users/models/model.go` | `internal/model/user.go` |
| `internal/users/services/users.go` | `internal/service/user.go` |
| `internal/users/views/users.go` | `internal/handler/user.go` |
| `internal/users/routers/routers.go` | `internal/router/router.go` (路由注册) |
| `internal/users/forms/users.go` | `api/v1/user.go` (Request 结构体) |

### 3.2 模块组织

**goInsight 模块结构:**
```
internal/users/
├── models/
├── services/
├── views/
├── forms/
└── routers/
```

**go-noah 模块结构:**
```
internal/
├── model/          # 所有模型
├── repository/     # 所有数据访问
├── service/        # 所有业务逻辑（全局变量）
├── handler/       # 所有HTTP处理（全局变量）
└── router/        # 路由注册
```

## 四、配置迁移对照

### 4.1 配置文件格式

**goInsight (config.yaml):**
```yaml
app:
  listen_address: "localhost:8083"
database:
  host: "127.0.0.1"
  port: 3306
  database: "goinsight"
  username: "goinsight_rw"
  password: "password"
redis:
  host: "127.0.0.1"
  port: 6379
  password: "1234.com"
  db: 0
```

**go-noah (config/local.yml):**
```yaml
http:
  host: 127.0.0.1
  port: 8000
data:
  db:
    user:
      driver: mysql
      dsn: root:password@tcp(127.0.0.1:3306)/goinsight?charset=utf8mb4&parseTime=True&loc=Local
  redis:
    addr: 127.0.0.1:6379
    password: 1234.com
    db: 0
```

### 4.2 配置读取

**goInsight:**
```go
global.App.Config.Database.Host
global.App.Config.Redis.Host
```

**go-noah:**
```go
conf.GetString("data.db.user.dsn")
conf.GetString("data.redis.addr")
```

## 五、权限控制迁移

### 5.1 简单权限检查 → Casbin RBAC

**goInsight:**
```go
if !user.IsSuperuser {
    c.JSON(http.StatusForbidden, gin.H{"msg": "permission denied"})
    return
}
```

**go-noah:**
```go
// 在路由中配置
strictAuthRouter := v1.Group("/").Use(
    middleware.StrictAuth(jwt, logger),
    middleware.AuthMiddleware(e),  // Casbin 权限检查
)

// 在 Casbin 策略中添加
// p, admin, api:/v1/users, GET
// p, user, api:/v1/users, GET
```

### 5.2 权限策略配置

**go-noah 权限策略示例:**
```
# API 权限
p, admin, api:/v1/users, GET
p, admin, api:/v1/users, POST
p, admin, api:/v1/users, PUT
p, admin, api:/v1/users, DELETE
p, user, api:/v1/users, GET

# 菜单权限
p, admin, menu:/users, read
p, user, menu:/profile, read
```

## 六、常见问题解决

### 6.1 如何处理全局配置？

**问题:** goInsight 使用 `global.App.Config`，go-noah 如何访问配置？

**解决:** 通过参数传递配置，或在 Service 中需要时通过参数传递
```go
func (s *UserService) GetConfig(ctx context.Context) (*Config, error) {
    // 配置在 noah.go 中初始化时传入，Service 方法中通过参数传递
    // 或者使用 global 包存储配置（如需要）
}
```

### 6.2 如何处理跨模块调用？

**问题:** goInsight 中可以直接调用 `global.App.DB`，go-noah 如何跨模块调用？

**解决:** 通过全局 Service 调用
```go
// 在 Service 中直接调用其他全局 Service
func (s *OrderService) CreateOrder(ctx context.Context, req *CreateOrderRequest) error {
    // 直接使用全局 Service
    user, err := service.UserServiceApp.GetUser(ctx, req.UserID)
    // ...
}
```

### 6.3 如何处理中间件？

**goInsight:**
```go
r.Use(middleware.JWTAuth())
r.Use(middleware.PermissionCheck())
```

**go-noah:**
```go
// 在 router/router.go 中
strictAuthRouter := v1.Group("/").Use(
    middleware.StrictAuth(jwt, logger),
    middleware.AuthMiddleware(e),
)
```

### 6.4 如何处理 WebSocket？

**goInsight:**
```go
r.GET("/ws", func(c *gin.Context) {
    // WebSocket 处理
})
```

**go-noah:**
```go
// 在 router/router.go 中
strictAuthRouter.GET("/ws", handler.WebSocketHandlerApp.HandleWebSocket)
```

## 七、迁移检查清单

### 代码层面
- [ ] 移除所有 `global.App` 引用
- [ ] 实现 Repository 结构体（不需要接口）
- [ ] 实现 Service 结构体（全局变量）
- [ ] 实现 Handler 结构体（全局变量，空结构体）
- [ ] 在 `internal/router/` 中注册路由
- [ ] 配置权限（Casbin）

### 功能层面
- [ ] 数据库操作正常
- [ ] Redis 操作正常（如需要）
- [ ] 日志记录正常
- [ ] 错误处理统一
- [ ] 权限控制正常

### 测试层面
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] API 测试通过

## 八、迁移工具和脚本

### 8.1 查找全局变量引用
```bash
# 查找所有 global.App 引用
grep -r "global.App" goinsight/internal/

# 查找所有 DB 操作
grep -r "global.App.DB" goinsight/internal/
```

### 8.2 批量替换（谨慎使用）
```bash
# 替换日志调用（需要手动检查）
sed -i 's/global.App.Log.Info/global.Logger.Info/g' file.go
```

### 8.3 代码生成工具
可以考虑编写脚本自动生成 Repository、Service、Handler 的基础代码结构。

## 九、最佳实践

1. **逐步迁移**: 先迁移一个完整模块，验证无误后再迁移其他模块
2. **保持兼容**: 迁移期间保持 API 兼容，避免影响前端
3. **充分测试**: 每个模块迁移后都要进行完整测试
4. **文档更新**: 及时更新 API 文档和代码注释
5. **代码审查**: 迁移后的代码要进行代码审查

## 十、参考资料

- [go-noah 框架文档](./go-noah/readmenew.md)
- [迁移计划](./迁移计划.md)
- [迁移示例](./迁移示例-用户模块.md)

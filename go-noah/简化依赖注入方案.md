# 简化依赖注入方案

## 问题

当前 `pkg/noah/noah.go` 中需要注册很多依赖，代码复杂：

```go
userRepo := repository.NewUserRepository(repo)
adminRepo := repository.NewAdminRepository(repo)

svc := service.NewService(tm, logger, s, j)
userSvc := service.NewUserService(svc, userRepo)
adminSvc := service.NewAdminService(svc, adminRepo)

h := handler.NewHandler(logger)
userHandler := handler.NewUserHandler(h, userSvc)
adminHandler := handler.NewAdminHandler(h, adminSvc)
```

## 解决方案：采用 gin-vue-admin 风格

### 方案一：完全简化（推荐）

**1. 创建 global 包（只包含基础设施）**

```go
// pkg/global/global.go
package global

import (
    "go-noah/internal/repository"
    "go-noah/pkg/jwt"
    "go-noah/pkg/log"
    "go-noah/pkg/sid"
    "github.com/casbin/casbin/v2"
    "gorm.io/gorm"
)

var (
    DB      *gorm.DB
    Logger  *log.Logger
    JWT     *jwt.JWT
    Sid     *sid.Sid
    Enforcer *casbin.SyncedEnforcer
    Repo    *repository.Repository
    Transaction repository.Transaction
)
```

**2. 简化 Service（直接定义为全局变量）**

```go
// internal/service/admin.go
type AdminService struct{}

var AdminServiceApp = new(AdminService)

func (s *AdminService) GetAdminUser(ctx context.Context, uid uint) (*v1.GetAdminUserResponseData, error) {
    // 直接使用 global.Repo 或 global.DB
    repo := repository.NewAdminRepository(global.Repo)
    user, err := repo.GetAdminUser(ctx, uid)
    // ...
}
```

**3. 简化 Handler（直接使用全局 Service）**

```go
// internal/handler/admin.go
type AdminHandler struct {
    *Handler
}

func NewAdminHandler(handler *Handler) *AdminHandler {
    return &AdminHandler{
        Handler: handler,
    }
}

func (h *AdminHandler) GetAdminUser(ctx *gin.Context) {
    // 直接使用全局 Service
    data, err := service.AdminServiceApp.GetAdminUser(ctx, uid)
    // ...
}
```

**4. 简化 noah.go（只需初始化基础设施）**

```go
// pkg/noah/noah.go
func NewServerApp(conf *viper.Viper, logger *log.Logger) (*app.App, func(), error) {
    // 只初始化基础设施
    global.Sid = sid.NewSid()
    global.JWT = jwt.NewJwt(conf)
    global.DB = repository.NewDB(conf, logger)
    global.Enforcer = repository.NewCasbinEnforcer(conf, logger, global.DB)
    global.Repo = repository.NewRepository(logger, global.DB, global.Enforcer)
    global.Transaction = repository.NewTransaction(global.Repo)
    global.Logger = logger

    // Service 不需要初始化（使用全局变量）
    // Handler 不需要传入 Service（直接使用全局 Service）
    h := handler.NewHandler(logger)
    adminHandler := handler.NewAdminHandler(h)
    userHandler := handler.NewUserHandler(h)

    httpServer := server.NewHTTPServer(logger, conf, global.JWT, global.Enforcer, adminHandler, userHandler)
    
    // ...
}
```

**对比：**

**修改前（复杂）：**
```go
userRepo := repository.NewUserRepository(repo)
adminRepo := repository.NewAdminRepository(repo)
svc := service.NewService(tm, logger, s, j)
userSvc := service.NewUserService(svc, userRepo)
adminSvc := service.NewAdminService(svc, adminRepo)
h := handler.NewHandler(logger)
userHandler := handler.NewUserHandler(h, userSvc)
adminHandler := handler.NewAdminHandler(h, adminSvc)
```

**修改后（简洁）：**
```go
// 只初始化基础设施
global.DB = repository.NewDB(conf, logger)
global.Enforcer = repository.NewCasbinEnforcer(conf, logger, global.DB)
global.Repo = repository.NewRepository(logger, global.DB, global.Enforcer)
global.Transaction = repository.NewTransaction(global.Repo)

// Service 和 Handler 不需要初始化
h := handler.NewHandler(logger)
adminHandler := handler.NewAdminHandler(h)
userHandler := handler.NewUserHandler(h)
```

## 方案二：保留 Repository 层，简化 Service 初始化

如果不想完全去掉依赖注入，可以只简化 Service 层：

```go
// Service 直接使用 global，不需要 New 函数
type AdminService struct{}

var AdminServiceApp = new(AdminService)

func (s *AdminService) GetAdminUser(ctx context.Context, uid uint) (*v1.GetAdminUserResponseData, error) {
    // 在方法内部创建 Repository
    repo := repository.NewAdminRepository(global.Repo)
    user, err := repo.GetAdminUser(ctx, uid)
    // ...
}
```

这样 noah.go 中就不需要初始化 Service 了：

```go
// 不需要这些
// userSvc := service.NewUserService(svc, userRepo)
// adminSvc := service.NewAdminService(svc, adminRepo)

// Handler 直接使用全局 Service
adminHandler := handler.NewAdminHandler(h, service.AdminServiceApp)
```

## 推荐方案

**建议采用方案一（完全简化）**：
- ✅ noah.go 代码减少 50%+
- ✅ 不需要注册 Service 和 Repository
- ✅ 更符合 gin-vue-admin 风格
- ✅ 代码更简洁易维护

**代价：**
- ❌ 使用全局变量（但只包含基础设施，影响不大）
- ❌ 测试需要设置全局变量（但可以接受）

## 实施步骤

1. 创建 `pkg/global/global.go`
2. 修改 Service，改为全局变量
3. 修改 Handler，不依赖 Service 参数
4. 简化 noah.go，只初始化基础设施
5. 更新所有使用处


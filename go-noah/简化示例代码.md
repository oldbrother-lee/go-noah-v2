# 简化依赖注入 - 示例代码

## 一、创建 global 包

```go
// pkg/global/global.go
package global

import (
	"go-noah/internal/repository"
	"go-noah/pkg/jwt"
	"go-noah/pkg/log"
	"go-noah/pkg/sid"

	"github.com/casbin/casbin/v2"
	"gorm.io/gorm"
)

// 全局基础设施组件（只包含基础设施，不包含业务层）
var (
	DB         *gorm.DB
	Logger     *log.Logger
	JWT        *jwt.JWT
	Sid        *sid.Sid
	Enforcer   *casbin.SyncedEnforcer
	Repo       *repository.Repository
	Transaction repository.Transaction
)
```

## 二、简化 Service

### 修改前
```go
type AdminService struct {
	*Service
	adminRepository *repository.AdminRepository
}

func NewAdminService(
	service *Service,
	adminRepository *repository.AdminRepository,
) *AdminService {
	return &AdminService{
		Service:         service,
		adminRepository: adminRepository,
	}
}
```

### 修改后
```go
// internal/service/admin.go
package service

import (
	"context"
	"go-noah/api/v1"
	"go-noah/internal/model"
	"go-noah/internal/repository"
	"go-noah/pkg/global"
)

// AdminService 管理员业务逻辑层（gin-vue-admin 风格）
type AdminService struct{}

var AdminServiceApp = new(AdminService)

func (s *AdminService) GetAdminUser(ctx context.Context, uid uint) (*v1.GetAdminUserResponseData, error) {
	// 在方法内部创建 Repository（或直接使用 global.DB）
	repo := repository.NewAdminRepository(global.Repo)
	user, err := repo.GetAdminUser(ctx, uid)
	if err != nil {
		return nil, err
	}
	roles, _ := repo.GetUserRoles(ctx, uid)
	// ...
}
```

## 三、简化 Handler

### 修改前
```go
type AdminHandler struct {
	*Handler
	adminService *service.AdminService
}

func NewAdminHandler(
	handler *Handler,
	adminService *service.AdminService,
) *AdminHandler {
	return &AdminHandler{
		Handler:      handler,
		adminService: adminService,
	}
}

func (h *AdminHandler) GetAdminUser(ctx *gin.Context) {
	data, err := h.adminService.GetAdminUser(ctx, uid)
	// ...
}
```

### 修改后
```go
// internal/handler/admin.go
type AdminHandler struct {
	*Handler
}

func NewAdminHandler(handler *Handler) *AdminHandler {
	return &AdminHandler{
		Handler: handler,
	}
}

func (h *AdminHandler) GetAdminUser(ctx *gin.Context) {
	// 直接使用全局 Service
	data, err := service.AdminServiceApp.GetAdminUser(ctx, uid)
	// ...
}
```

## 四、简化 noah.go

### 修改前（复杂）
```go
func NewServerApp(conf *viper.Viper, logger *log.Logger) (*app.App, func(), error) {
	s := sid.NewSid()
	j := jwt.NewJwt(conf)
	db := repository.NewDB(conf, logger)
	e := repository.NewCasbinEnforcer(conf, logger, db)
	repo := repository.NewRepository(logger, db, e)
	tm := repository.NewTransaction(repo)

	userRepo := repository.NewUserRepository(repo)
	adminRepo := repository.NewAdminRepository(repo)

	svc := service.NewService(tm, logger, s, j)
	userSvc := service.NewUserService(svc, userRepo)
	adminSvc := service.NewAdminService(svc, adminRepo)

	h := handler.NewHandler(logger)
	userHandler := handler.NewUserHandler(h, userSvc)
	adminHandler := handler.NewAdminHandler(h, adminSvc)

	httpServer := server.NewHTTPServer(logger, conf, j, e, adminHandler, userHandler)
	// ...
}
```

### 修改后（简洁）
```go
func NewServerApp(conf *viper.Viper, logger *log.Logger) (*app.App, func(), error) {
	// 只初始化基础设施（存入 global）
	global.Sid = sid.NewSid()
	global.JWT = jwt.NewJwt(conf)
	global.DB = repository.NewDB(conf, logger)
	global.Enforcer = repository.NewCasbinEnforcer(conf, logger, global.DB)
	global.Repo = repository.NewRepository(logger, global.DB, global.Enforcer)
	global.Transaction = repository.NewTransaction(global.Repo)
	global.Logger = logger

	// Service 不需要初始化（使用全局变量）
	// Handler 不需要传入 Service（直接使用全局 Service）
	h := handler.NewHandler(logger)
	adminHandler := handler.NewAdminHandler(h)
	userHandler := handler.NewUserHandler(h)

	httpServer := server.NewHTTPServer(logger, conf, global.JWT, global.Enforcer, adminHandler, userHandler)
	// ...
}
```

## 对比

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| **noah.go 行数** | ~30 行 | ~15 行 |
| **Service 初始化** | 需要 New 函数 | 全局变量 |
| **Handler 初始化** | 需要传入 Service | 不需要 |
| **代码复杂度** | 高 | 低 |

## 优势

- ✅ **代码减少 50%+**：noah.go 从 30 行减少到 15 行
- ✅ **不需要注册依赖**：Service 和 Repository 自动使用 global
- ✅ **更简洁**：符合 gin-vue-admin 风格
- ✅ **易于维护**：新增 Service 不需要修改 noah.go

## 注意事项

- Service 方法内部创建 Repository（或直接使用 global.DB）
- 测试时需要设置 global 变量
- 全局变量只包含基础设施，业务层使用全局 Service


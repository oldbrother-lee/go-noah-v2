# 用户模块迁移完成

## 迁移内容

按照迁移计划，完成了用户模块从 goInsight 到 go-noah 的迁移。

## 完成的文件

### 1. Model 层
**文件：** `internal/model/user.go`

- ✅ 迁移了完整的 User 模型结构
- ✅ 包含所有字段：Uid, Username, Password, Email, NickName, Mobile, AvatarFile, RoleID, IsSuperuser, IsActive, IsStaff, IsTwoFA, OtpSecret, LastLogin, DateJoined, UpdatedAt
- ✅ 表名：`insight_users`

### 2. Repository 层
**文件：** `internal/repository/user.go`

- ✅ `GetUser` - 根据 UID 获取用户
- ✅ `GetUserByUsername` - 根据用户名获取用户
- ✅ `GetUsers` - 分页获取用户列表（支持搜索、角色过滤）
- ✅ `CreateUser` - 创建用户
- ✅ `UpdateUser` - 更新用户
- ✅ `DeleteUser` - 删除用户
- ✅ `UpdatePassword` - 更新密码

### 3. Service 层
**文件：** `internal/service/user.go`

- ✅ `GetUser` - 获取用户详情
- ✅ `GetUsers` - 获取用户列表（分页、搜索、过滤）
- ✅ `CreateUser` - 创建用户（密码加密、用户名唯一性检查）
- ✅ `UpdateUser` - 更新用户（用户名唯一性检查）
- ✅ `DeleteUser` - 删除用户
- ✅ `ChangePassword` - 修改密码（密码验证）

### 4. API 结构体
**文件：** `api/user.go`

- ✅ `CreateUserRequest` - 创建用户请求
- ✅ `UpdateUserRequest` - 更新用户请求
- ✅ `GetUsersRequest` - 获取用户列表请求
- ✅ `ChangePasswordRequest` - 修改密码请求
- ✅ `UserData` - 用户数据
- ✅ `GetUsersResponseData` - 获取用户列表响应
- ✅ `GetUserResponseData` - 获取用户详情响应

### 5. Handler 层
**文件：** `internal/handler/user.go`

- ✅ `GetUsers` - 获取用户列表（GET /v1/users）
- ✅ `GetUser` - 获取用户详情（GET /v1/users/:uid）
- ✅ `CreateUser` - 创建用户（POST /v1/users）
- ✅ `UpdateUser` - 更新用户（PUT /v1/users/:uid）
- ✅ `DeleteUser` - 删除用户（DELETE /v1/users/:uid）
- ✅ `ChangePassword` - 修改密码（PUT /v1/users/password）

### 6. 路由注册
**文件：** `internal/router/router.go`

- ✅ 在 `InitUserRouter` 中注册了所有用户相关路由
- ✅ 配置了权限中间件

## 关键实现细节

### 1. 使用 r.DB(ctx) 而不是 global.DB

为了避免循环导入，Repository 使用 `r.DB(ctx)` 方法，该方法：
- 支持事务上下文
- 自动处理事务和普通查询

### 2. Service 使用全局变量

```go
type UserService struct{}

var UserServiceApp = new(UserService)

func (s *UserService) getUserRepo() *repository.UserRepository {
    return repository.NewUserRepository(global.Repo)
}
```

### 3. Handler 使用全局变量

```go
type UserHandler struct{}

var UserHandlerApp = new(UserHandler)

func (h *UserHandler) GetUsers(ctx *gin.Context) {
    data, err := service.UserServiceApp.GetUsers(ctx.Request.Context(), &req)
    // ...
}
```

## API 端点

| 方法 | 路径 | 功能 | 权限 |
|------|------|------|------|
| GET | `/v1/users` | 获取用户列表 | 需要认证 |
| GET | `/v1/users/:uid` | 获取用户详情 | 需要认证 |
| POST | `/v1/users` | 创建用户 | 需要认证 |
| PUT | `/v1/users/:uid` | 更新用户 | 需要认证 |
| DELETE | `/v1/users/:uid` | 删除用户 | 需要认证 |
| PUT | `/v1/users/password` | 修改密码 | 需要认证 |

## 与 goInsight 的对比

| 功能 | goInsight | go-noah |
|------|-----------|---------|
| **获取用户列表** | `GetUsersView` | `UserHandlerApp.GetUsers` |
| **创建用户** | `CreateUsersView` | `UserHandlerApp.CreateUser` |
| **更新用户** | `UpdateUsersView` | `UserHandlerApp.UpdateUser` |
| **删除用户** | `DeleteUsersView` | `UserHandlerApp.DeleteUser` |
| **修改密码** | `ChangeUsersPasswordView` | `UserHandlerApp.ChangePassword` |

## 待完善功能

根据 goInsight 的原始实现，以下功能可以后续添加：

1. **组织架构关联** - 当前 `GetUsers` 支持 `organizationKey` 参数，但未实现关联查询
2. **头像上传** - `ChangeUserAvatarView` 功能未迁移
3. **2FA 相关** - OTP 相关功能可以后续完善

## 完成状态

✅ 用户模块核心功能已迁移完成
✅ 所有代码已通过 linter 检查
✅ 路由已注册并配置权限


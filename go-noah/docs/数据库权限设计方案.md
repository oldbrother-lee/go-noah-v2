# 数据库权限设计方案

## 一、设计原则

### 1.1 权限范围

**权限仅用于数据查询（DAS）**：
- ✅ 控制用户可以查询哪些数据库（Schema）
- ✅ 控制用户可以查询哪些表（Table）
- ❌ **不需要操作权限**（SELECT、INSERT、UPDATE、DELETE等），所有 DML/DDL 操作走工单审批流程

### 1.2 核心思想

1. **基于角色（RBAC）**：权限通过角色管理，用户通过角色获得权限
2. **权限模板化**：常用权限组合定义为模板，提高复用性
3. **权限组**：将常用的数据库组合定义为权限组
4. **批量操作**：支持批量授权、批量撤销
5. **向后兼容**：保留现有的直接授权方式

---

## 二、当前问题分析

### 2.1 现有设计问题

当前的数据库权限设计为：
- **库权限（Schema Permission）**：基于用户名 + 实例ID + 库名的三元组授权
- **表权限（Table Permission）**：基于用户名 + 实例ID + 库名 + 表名的四元组授权

**存在的问题：**
1. **授权效率低**：需要为每个用户逐个数据库/表授权，操作繁琐
2. **管理成本高**：权限变更需要逐个修改，维护困难
3. **缺少批量操作**：无法批量授权、批量撤销
4. **权限复用性差**：相同权限需要重复配置

### 2.2 用户场景需求

根据实际使用场景，权限管理需求包括：
1. **角色权限模板**：DBA、开发、测试等角色有固定的权限模板
2. **批量授权**：为多个用户同时授予相同权限
3. **权限组**：将常用的数据库组合定义为权限组，一键授权
4. **权限继承**：用户继承角色权限

---

## 三、数据模型设计

### 3.1 权限模板表（`das_permission_templates`）

```sql
CREATE TABLE `das_permission_templates` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(128) NOT NULL COMMENT '模板名称',
  `description` VARCHAR(512) COMMENT '模板描述',
  `permissions` JSON NOT NULL COMMENT '权限配置（JSON数组）',
  `created_at` DATETIME NOT NULL,
  `updated_at` DATETIME NOT NULL,
  `deleted_at` DATETIME,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`, `deleted_at`)
) COMMENT='DAS权限模板表';
```

**权限配置JSON格式：**
```json
[
  {
    "instance_id": "uuid1",
    "schema": "db1"
  },
  {
    "instance_id": "uuid1",
    "schema": "db2",
    "tables": ["table1", "table2"]
  },
  {
    "instance_id": "uuid2",
    "schema": "db3"
  }
]
```

**说明：**
- `instance_id` + `schema`：授权整个数据库
- `instance_id` + `schema` + `tables`：授权数据库中的指定表
- 如果 `tables` 为空数组或不存在，表示授权整个数据库的所有表

### 3.2 权限组表（`das_permission_groups`）

```sql
CREATE TABLE `das_permission_groups` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(128) NOT NULL COMMENT '权限组名称',
  `description` VARCHAR(512) COMMENT '权限组描述',
  `databases` JSON NOT NULL COMMENT '数据库列表（JSON数组）',
  `created_at` DATETIME NOT NULL,
  `updated_at` DATETIME NOT NULL,
  `deleted_at` DATETIME,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`, `deleted_at`)
) COMMENT='DAS权限组表';
```

**数据库列表JSON格式：**
```json
[
  {"instance_id": "uuid1", "schema": "db1"},
  {"instance_id": "uuid1", "schema": "db2"},
  {"instance_id": "uuid2", "schema": "db3"}
]
```

### 3.3 角色权限表（`das_role_permissions`）

```sql
CREATE TABLE `das_role_permissions` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `role` VARCHAR(128) NOT NULL COMMENT '角色标识（Casbin role，如：dba、developer）',
  `permission_type` ENUM('object', 'template', 'group') NOT NULL COMMENT '权限类型',
  `permission_id` BIGINT UNSIGNED NOT NULL COMMENT '权限ID（权限对象/模板/组的ID）',
  `created_at` DATETIME NOT NULL,
  `updated_at` DATETIME NOT NULL,
  `deleted_at` DATETIME,
  PRIMARY KEY (`id`),
  KEY `idx_role` (`role`, `deleted_at`),
  KEY `idx_permission` (`permission_type`, `permission_id`)
) COMMENT='DAS角色权限表';
```

**说明：**
- `permission_type = 'object'`：直接权限对象（展开后的具体权限）
- `permission_type = 'template'`：关联权限模板
- `permission_type = 'group'`：关联权限组

### 3.4 用户权限表（可选，用于特殊场景的直接授权）

**库权限表（`das_user_schema_permissions`）**：可选，用于特殊场景的直接授权
**表权限表（`das_user_table_permissions`）**：可选，用于特殊场景的直接授权

**说明**：在开发阶段，优先使用角色权限管理，用户直接权限表可以暂时不使用或仅用于特殊场景。

### 3.5 用户角色关联（使用现有系统）

使用现有的 Casbin 角色系统：
- `casbin_rule` 表：存储用户-角色关联（`g, user_id, role`）

---

## 四、权限计算逻辑

### 4.1 权限合并规则

用户最终权限 = 角色权限（展开模板/组）

**说明**：在开发阶段，优先使用角色权限管理，用户直接权限暂不考虑。

### 4.2 权限解析流程

```
1. 获取用户所属角色列表（从Casbin）
   ↓
2. 获取角色权限（从das_role_permissions）
   ↓
3. 展开权限模板/权限组，转换为具体权限对象
   ↓
4. 合并权限（去重）
   ↓
5. 返回最终权限列表
```

### 4.3 权限检查逻辑

```go
// 伪代码
func CheckUserSchemaPermission(username string, instanceID string, schema string) bool {
    // 1. 获取用户角色
    roles := GetUserRoles(username)
    
    // 2. 获取角色权限
    for _, role := range roles {
        rolePerms := GetRolePermissions(role)
        for _, perm := range rolePerms {
            // 展开权限模板/权限组
            actualPerms := ExpandPermission(perm)
            if HasSchemaPermission(actualPerms, instanceID, schema) {
                return true
            }
        }
    }
    
    return false
}

func CheckUserTablePermission(username string, instanceID string, schema string, table string) bool {
    // 1. 检查库权限（如果用户有整个库的权限，则所有表都有权限）
    if CheckUserSchemaPermission(username, instanceID, schema) {
        // 2. 检查是否有表级别的限制（从角色权限中获取）
        rolePerms := GetUserRolePermissions(username)
        // 如果角色权限中有表级别的限制，检查当前表是否在允许列表中
        if HasTableRestrictions(rolePerms, instanceID, schema) {
            return IsTableInPermissionList(rolePerms, instanceID, schema, table)
        }
        return true
    }
    
    return false
}
```

---

## 五、API设计

### 5.1 权限模板API

```
GET    /api/v1/insight/das/permissions/templates          # 获取权限模板列表
POST   /api/v1/insight/das/permissions/templates          # 创建权限模板
GET    /api/v1/insight/das/permissions/templates/:id      # 获取权限模板详情
PUT    /api/v1/insight/das/permissions/templates/:id      # 更新权限模板
DELETE /api/v1/insight/das/permissions/templates/:id      # 删除权限模板
```

### 5.2 权限组API

```
GET    /api/v1/insight/das/permissions/groups             # 获取权限组列表
POST   /api/v1/insight/das/permissions/groups             # 创建权限组
GET    /api/v1/insight/das/permissions/groups/:id         # 获取权限组详情
PUT    /api/v1/insight/das/permissions/groups/:id         # 更新权限组
DELETE /api/v1/insight/das/permissions/groups/:id         # 删除权限组
```

### 5.3 角色权限API

```
GET    /api/v1/insight/das/permissions/roles/:role        # 获取角色权限
POST   /api/v1/insight/das/permissions/roles/:role        # 为角色添加权限（批量）
DELETE /api/v1/insight/das/permissions/roles/:role/:id    # 删除角色单个权限
```

### 5.4 用户权限API

```
GET    /api/v1/insight/das/permissions/users/:username    # 获取用户权限（展开角色权限后）
```

**说明**：用户权限通过角色管理，不需要直接授权API。

---

## 六、前端界面设计

### 6.1 权限管理页面结构

```
数据库权限管理
├── 权限模板管理
│   ├── 模板列表
│   ├── 创建/编辑模板
│   └── 模板详情（权限配置）
├── 权限组管理
│   ├── 权限组列表
│   ├── 创建/编辑权限组
│   └── 权限组详情
├── 角色权限管理
│   ├── 选择角色
│   ├── 角色权限配置
│   │   ├── 权限对象（实例+库+表）
│   │   ├── 权限模板
│   │   └── 权限组
│   └── 权限预览（展开后）
└── 用户权限查看
    └── 查看用户权限（展开角色权限后显示）
```

### 6.2 权限模板配置界面

**模板配置界面：**
- 模板基本信息（名称、描述）
- 权限配置
  - 添加实例+库（授权整个库）
  - 添加实例+库+表（授权特定表）
  - 支持批量添加
  - 支持删除
- 保存为模板

### 6.3 权限组配置界面

**权限组配置界面：**
- 权限组基本信息（名称、描述）
- 数据库列表
  - 添加实例+库
  - 支持批量添加
  - 支持删除
- 保存为权限组

### 6.4 角色权限配置界面

**角色权限配置界面：**
- 选择角色（下拉选择）
- 权限列表
  - 权限对象（实例+库+表）
  - 权限模板（显示模板名称，可展开查看）
  - 权限组（显示组名称，可展开查看）
- 添加权限
  - 选择权限类型（对象/模板/组）
  - 如果选择对象：配置实例+库+表
  - 如果选择模板：选择模板
  - 如果选择组：选择权限组
- 权限预览（展开所有模板和组，显示最终权限）

### 6.5 用户权限查看界面

**用户权限查看界面：**
- 用户选择
- 权限展示
  - 角色权限（标记角色和来源：模板/组/对象）
  - 最终权限（展开并合并去重后）
- 权限来源展示（显示权限来自哪个角色、哪个模板/组）

---

## 七、实施建议

### 7.1 分阶段实施

**第一阶段：基础功能**
1. 实现权限模板管理（数据模型 + API + 前端）
2. 实现权限组管理（数据模型 + API + 前端）
3. 实现角色权限关联（数据模型 + API）

**第二阶段：权限计算**
1. 实现权限展开逻辑（模板/组 → 具体权限）
2. 实现权限合并逻辑（用户直接权限 + 角色权限）
3. 优化权限检查逻辑（集成到 DAS 查询接口）

**第三阶段：批量操作**
1. 实现批量授权功能
2. 实现权限预览功能
3. 优化用户权限查看界面

**第四阶段：高级功能（可选）**
1. 权限继承（角色继承）
2. 权限审计日志
3. 权限变更通知

### 7.2 数据迁移（可选）

如果需要迁移现有权限数据：
1. 分析现有权限数据，识别常用权限组合
2. 创建对应的权限模板或权限组
3. 为角色关联权限模板/组
4. 将用户分配到对应角色

### 7.3 性能优化

1. **权限缓存**：用户权限计算后缓存（Redis），减少数据库查询
2. **批量查询**：批量获取权限时优化查询逻辑
3. **权限索引**：为权限表添加合适的索引

---

## 八、示例场景

### 8.1 场景1：为开发团队授权

**需求**：为开发团队的10个用户授予开发环境所有库的查询权限

**操作步骤：**
1. 创建权限模板"开发环境所有库"：
   ```json
   [
     {"instance_id": "dev-instance-uuid", "schema": "db1"},
     {"instance_id": "dev-instance-uuid", "schema": "db2"},
     {"instance_id": "dev-instance-uuid", "schema": "db3"}
   ]
   ```
2. 为角色"developer"关联权限模板"开发环境所有库"
3. 将10个用户添加到角色"developer"

**优势：**
- 只需配置一次权限模板
- 后续新用户只需添加到角色即可
- 权限变更只需修改模板，所有用户自动生效

### 8.2 场景2：批量授权公共库

**需求**：为所有用户授予公共库的查询权限

**操作步骤：**
1. 创建权限组"公共库组"：
   ```json
   [
     {"instance_id": "prod-instance-uuid", "schema": "public_db1"},
     {"instance_id": "prod-instance-uuid", "schema": "public_db2"}
   ]
   ```
2. 创建权限模板"公共库查询"：
   - 关联权限组"公共库组"
3. 为角色"guest"（访客角色）关联权限模板
4. 所有用户默认拥有"guest"角色

**优势：**
- 一次配置，所有用户生效
- 新增公共库只需更新权限组

### 8.3 场景3：临时授权

**需求**：为某个用户临时授予某个数据库的权限

**操作步骤：**
1. 创建临时权限模板或权限对象
2. 创建临时角色或使用现有角色
3. 为角色关联临时权限
4. 将用户添加到角色
5. 使用完毕后，从角色中移除用户或删除临时权限

---

## 九、数据模型详细设计

### 9.1 Go 模型定义

```go
// 权限模板
type DASPermissionTemplate struct {
    gorm.Model
    Name        string          `gorm:"type:varchar(128);not null;uniqueIndex:uk_name" json:"name"`
    Description string          `gorm:"type:varchar(512)" json:"description"`
    Permissions datatypes.JSON  `gorm:"type:json;not null" json:"permissions"` // 权限配置JSON
}

// 权限组
type DASPermissionGroup struct {
    gorm.Model
    Name        string          `gorm:"type:varchar(128);not null;uniqueIndex:uk_name" json:"name"`
    Description string          `gorm:"type:varchar(512)" json:"description"`
    Databases   datatypes.JSON  `gorm:"type:json;not null" json:"databases"` // 数据库列表JSON
}

// 角色权限
type DASRolePermission struct {
    gorm.Model
    Role          string `gorm:"type:varchar(128);not null;index:idx_role" json:"role"`
    PermissionType string `gorm:"type:enum('object','template','group');not null" json:"permission_type"`
    PermissionID  uint   `gorm:"not null;index:idx_permission" json:"permission_id"`
}

// 权限对象（用于角色权限中的 object 类型）
type DASPermissionObject struct {
    InstanceID uuid.UUID `json:"instance_id"`
    Schema     string    `json:"schema"`
    Tables     []string  `json:"tables,omitempty"` // 可选，如果为空则表示整个库
}
```

---

## 十、总结

### 10.1 核心优势

1. **提高效率**：通过权限模板和权限组，减少重复配置
2. **便于管理**：基于角色的权限管理，集中配置
3. **灵活扩展**：支持权限模板、权限组、直接授权多种方式
4. **向后兼容**：保留现有功能，平滑迁移
5. **简化设计**：只关注数据查询权限，DML/DDL走工单流程

### 10.2 关键特性

- ✅ 权限模板化：常用权限组合定义为模板
- ✅ 权限组：数据库组合定义为权限组
- ✅ 角色权限：权限通过角色管理
- ✅ 批量操作：支持批量授权、批量撤销
- ✅ 灵活配置：支持多种授权方式
- ✅ 简化权限：只控制数据查询，不控制操作类型

---

## 十一、后续优化方向

1. **权限审计**：记录权限变更日志，支持权限审计
2. **权限过期**：支持权限有效期，自动过期（可选）
3. **权限可视化**：权限关系图谱可视化
4. **权限统计**：权限使用情况统计

# 字符集检查问题分析报告

## 问题描述

SQL 语法检测报错：`表`users1`指定的字符集`utf8`不符合要求，可选字符集为[]`

错误信息显示 `可选字符集为[]`，说明 `TABLE_SUPPORT_CHARSET` 为空数组。

## 问题原因分析

### 根本原因：默认参数格式错误

**问题1：JSON 反序列化方式**

#### 老代码（goinsight）的实现方式

**文件**: `goinsight/internal/inspect/checker/check.go`

**实现逻辑**:
1. `initDefaultInspectParams()`: 先从 `insight_inspect_params` 表读取默认参数，初始化 `s.InspectParams`
2. `initDBInspectParams()`: 再从数据库配置的 `InspectParams` JSON 字段读取参数

```go
// 初始化DB审核参数
func (s *SyntaxInspectService) initDBInspectParams() error {
    // 序列化参数
    jsonParams, err := json.Marshal(s.DBParams)
    if err != nil {
        return fmt.Errorf("序列化JSON参数失败: %v", err)
    }
    r := bytes.NewReader([]byte(jsonParams))
    decoder := json.NewDecoder(r)
    // 动态参数赋值给默认模板
    // 优先级: post instance params > 内置默认参数
    if err := decoder.Decode(&s.InspectParams); err != nil {
        return err
    }
    return nil
}
```

**关键点**：
- 使用 `json.Decoder.Decode()` 方法
- `decoder.Decode()` 会**保留现有结构体中的值**，只覆盖 JSON 中存在的字段
- 如果 JSON 中没有 `TABLE_SUPPORT_CHARSET` 字段，会保留默认参数中的值

#### 新代码（go-noah）的初始实现方式（已修复）

**文件**: `go-noah/internal/handler/insight/inspect.go`

**修复后逻辑**:
```go
if dbConfig.InspectParams != nil && len(dbConfig.InspectParams) > 0 {
    // 先创建默认参数作为基础
    params = config.DefaultInspectParams()
    // 从数据库配置中反序列化参数，覆盖默认值（使用 Decoder，保留默认值，只覆盖存在的字段）
    r := bytes.NewReader(dbConfig.InspectParams)
    decoder := json.NewDecoder(r)
    if err := decoder.Decode(params); err != nil {
        // 错误处理
    }
}
```

**关键点**：
- 使用 `json.Decoder.Decode()` 方法（已修复）
- `decoder.Decode()` 会**保留现有结构体中的值**，只覆盖 JSON 中存在的字段
- 如果 JSON 中没有 `TABLE_SUPPORT_CHARSET` 字段，会保留默认参数中的值

---

**问题2：默认参数格式错误（真正的根本原因）**

#### 老代码的默认参数格式

**文件**: `goinsight/bootstrap/db.go` (第 226-228 行)

```go
{"params": map[string][]map[string]string{"TABLE_SUPPORT_CHARSET": {
    {"charset": "utf8", "recommend": "utf8_general_ci"},
    {"charset": "utf8mb4", "recommend": "utf8mb4_general_ci"},
}}}
```

**格式说明**：
- `[]map[string]string`：数组中的每个元素是一个 map
- 每个 map 的键是 **`"charset"`** 和 **`"recommend"`**
- 值分别是字符集名和排序规则名

#### 新代码的默认参数格式（错误）

**文件**: `go-noah/internal/inspect/config/config.go` (第 101 行)

```go
TABLE_SUPPORT_CHARSET: []map[string]string{{"utf8mb4": "utf8mb4_general_ci"}},
```

**格式说明**：
- `[]map[string]string`：数组中的每个元素是一个 map
- 每个 map 的键是 **字符集名**（如 `"utf8mb4"`），值是排序规则名
- ❌ **格式错误**：缺少 `"charset"` 和 `"recommend"` 键

#### 提取逻辑（两个项目相同）

**文件**: `go-noah/internal/inspect/process/table.go` (第 116-120 行)

```go
for _, item := range t.InspectParams.TABLE_SUPPORT_CHARSET {
    tblSupportCharset = append(tblSupportCharset, item["charset"])  // ❌ 找不到 "charset" 键！
    if len(t.Charset) > 0 && item["charset"] == t.Charset {
        tblRecommendCollation = item["recommend"]  // ❌ 找不到 "recommend" 键！
    }
}
```

**问题**：
- 代码期望 map 中有 `"charset"` 和 `"recommend"` 键
- 但新代码的默认参数格式是 `{"utf8mb4": "utf8mb4_general_ci"}`，键是字符集名，不是 `"charset"`
- 所以 `item["charset"]` 返回空字符串，导致 `tblSupportCharset` 为空数组 `[]`

---

## 解决方案

### 修复方案：更正默认参数格式

修改 `go-noah/internal/inspect/config/config.go` 中的 `DefaultInspectParams()` 函数，将 `TABLE_SUPPORT_CHARSET` 的格式改为与老代码一致：

**修改前**：
```go
TABLE_SUPPORT_CHARSET: []map[string]string{{"utf8mb4": "utf8mb4_general_ci"}},
```

**修改后**：
```go
TABLE_SUPPORT_CHARSET: []map[string]string{
    {"charset": "utf8", "recommend": "utf8_general_ci"},
    {"charset": "utf8mb4", "recommend": "utf8mb4_general_ci"},
},
```

**同时修改** `go-noah/internal/handler/insight/inspect.go` 中恢复默认值的代码：

**修改前**：
```go
params.TABLE_SUPPORT_CHARSET = []map[string]string{{"utf8mb4": "utf8mb4_general_ci"}}
```

**修改后**：
```go
params.TABLE_SUPPORT_CHARSET = []map[string]string{
    {"charset": "utf8", "recommend": "utf8_general_ci"},
    {"charset": "utf8mb4", "recommend": "utf8mb4_general_ci"},
}
```

---

## 验证步骤

1. 修复后，测试 SQL 语法检查
2. 验证 `TABLE_SUPPORT_CHARSET` 格式是否正确
3. 确认错误信息中显示正确的可选字符集列表（如 `[utf8 utf8mb4]`）

---

## 总结

问题的根本原因是：
1. **默认参数格式错误**：新代码使用 `{"utf8mb4": "utf8mb4_general_ci"}` 格式，而提取逻辑期望 `{"charset": "...", "recommend": "..."}` 格式
2. **JSON 反序列化方式**：已修复为使用 `json.Decoder.Decode()`，保留默认值

需要修复的是默认参数格式，确保与老代码和提取逻辑一致。

# 工单执行权限配置说明

## 一、权限检查逻辑

### 1.1 权限检查规则

工单执行权限检查遵循以下规则：

1. **Admin 用户自动拥有所有权限**
   - 用户ID = 1（超级管理员）
   - 拥有 `admin` 角色的用户
   - **这两种用户可以直接执行任何工单，无需在 executor 列表中**

2. **普通用户需要权限验证**
   - 必须在该工单的 `executor` 列表中
   - 工单状态必须是"已批准"或"执行中"

### 1.2 权限检查流程

```go
checkOrderStatus(orderID, username, userID) {
    // 1. 检查用户是否是 admin
    if (userID == 1 || 用户拥有 admin 角色) {
        // admin 用户，跳过 executor 权限检查
        isAdmin = true
    }
    
    // 2. 如果不是 admin，检查 executor 列表
    if (!isAdmin) {
        if (executor 列表不为空 && 用户不在列表中) {
            return 403 权限不足
        }
    }
    
    // 3. 检查工单状态
    if (工单状态不是"已批准"或"执行中") {
        return 400 工单状态不允许执行
    }
}
```

## 二、权限配置方式

### 2.1 方式一：设置为 Admin 用户（推荐用于管理员）

#### 方法 1：使用用户ID=1
系统默认用户ID=1的用户是超级管理员，拥有所有权限。

#### 方法 2：给用户分配 admin 角色

**步骤：**

1. 登录系统（使用用户ID=1的账号）

2. 给用户分配 `admin` 角色：
   ```sql
   -- 查看用户ID
   SELECT id, username FROM admin_users WHERE username = 'your_username';
   
   -- 查看 admin 角色的 ID
   SELECT id FROM roles WHERE sid = 'admin';
   
   -- 给用户分配 admin 角色（使用 Casbin）
   -- 这需要通过 API 或直接在数据库中操作 casbin_rule 表
   ```

3. **通过 API 分配角色**（推荐）：
   - 调用 `/api/v1/admin/role/permission` API
   - 或者通过前端界面在"角色管理"中给用户分配 `admin` 角色

### 2.2 方式二：将用户添加到工单的 Executor 列表（推荐用于普通用户）

在创建或更新工单时，将用户添加到 `executor` 字段：

```json
{
  "title": "测试工单",
  "executor": ["username1", "username2"],  // 添加执行人
  ...
}
```

**注意：**
- `executor` 是一个字符串数组
- 数组中的值是用户的 `username`（用户名），不是用户ID
- 如果 `executor` 为空或 null，只有 admin 用户可以执行

## 三、常见问题

### Q1: 为什么返回 403 权限不足？

**原因：**
1. 用户不是 admin（用户ID≠1 且没有 admin 角色）
2. 工单的 `executor` 列表不为空，但当前用户不在列表中

**解决方案：**
- **方案A（管理员）**：将用户设置为 admin 角色
- **方案B（普通用户）**：在创建/更新工单时，将用户添加到 `executor` 列表

### Q2: 如何查看当前用户的角色？

**API 调用：**
```bash
GET /api/v1/admin/user
Authorization: Bearer {token}
```

**响应示例：**
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "id": 1,
    "username": "admin",
    "nickname": "管理员",
    "roles": ["admin"]  // 这里显示用户的角色
  }
}
```

### Q3: 如何给用户分配 admin 角色？

**通过前端界面：**
1. 登录系统（使用用户ID=1的账号）
2. 进入"用户管理" -> 选择用户 -> "分配角色"
3. 勾选 `admin` 角色

**通过 SQL（不推荐，仅用于紧急情况）：**
```sql
-- 1. 查看用户ID和admin角色ID
SELECT id, username FROM admin_users WHERE username = 'your_username';
SELECT id FROM roles WHERE sid = 'admin';

-- 2. 查看 casbin_rule 表结构
-- 格式：g, {user_id}, {role_sid}

-- 3. 插入权限记录（示例：用户ID=2，admin角色）
INSERT INTO casbin_rule (ptype, v0, v1) VALUES ('g', '2', 'admin');
```

### Q4: executor 列表为空怎么办？

如果工单的 `executor` 字段为空或 null：
- **只有 admin 用户可以执行**
- 普通用户会返回 403 权限不足

**建议：** 在创建工单时，明确指定 `executor` 列表，或者将执行用户设置为 admin。

## 四、权限配置最佳实践

### 4.1 管理员用户
- 建议使用用户ID=1的账号，或者给管理员用户分配 `admin` 角色
- Admin 用户可以执行所有工单，无需配置 executor

### 4.2 普通用户
- 在创建工单时，明确指定 `executor` 列表
- 确保 `executor` 中的用户名正确（区分大小写）
- 如果工单需要多人执行，将所有人都添加到 `executor` 列表

### 4.3 开发/测试环境
- 可以给所有测试用户分配 `admin` 角色，方便测试
- 生产环境建议严格控制 admin 角色的分配

## 五、代码示例

### 5.1 创建工单时指定执行人

```json
POST /api/v1/insight/orders
{
  "title": "测试工单",
  "executor": ["user1", "user2"],  // 指定执行人
  "approver": ["approver1"],
  "reviewer": ["reviewer1"],
  ...
}
```

### 5.2 检查用户是否有执行权限（代码层面）

```go
// 在 handler 中
userId := handler.GetUserIdFromCtx(c)
username := "user1"

// 检查权限
err := h.checkOrderStatus(ctx, orderID, username, userId)
if err != nil {
    // 权限不足
    return
}
```


# 新老系统管理功能差异分析方案

## 一、概述

本文档对比分析新系统（go-noah）和老系统（goinsight）在管理功能上的主要差异，重点关注：
1. **环境管理**
2. **数据库配置管理**
3. **权限分配**

---

## 二、环境管理差异

### 2.1 API 端点对比

| 功能 | 老系统（goinsight） | 新系统（go-noah） |
|------|-------------------|------------------|
| **获取环境列表** | `GET /api/v1/admin/environment` | `GET /api/v1/insight/environments` |
| **创建环境** | `POST /api/v1/admin/environment` | `POST /api/v1/insight/environments` |
| **更新环境** | `PUT /api/v1/admin/environment/:id` | `PUT /api/v1/insight/environments/:id` |
| **删除环境** | `DELETE /api/v1/admin/environment/:id` | `DELETE /api/v1/insight/environments/:id` |

### 2.2 权限控制差异

#### 老系统（goinsight）
- **权限检查方式**：`middleware.HasAdminPermission()`
- **检查逻辑**：检查用户的 `IsSuperuser` 字段是否为 `true`
- **代码位置**：`goinsight/middleware/permissions.go`
- **特点**：
  - 简单的布尔值检查
  - 只有超级管理员可以管理环境
  - 权限控制粒度粗

```go
// 老系统权限检查
func HasAdminPermission() gin.HandlerFunc {
    return func(c *gin.Context) {
        username := jwt.ExtractClaims(c)["id"].(string)
        var user userModels.InsightUsers
        global.App.DB.Table("insight_users u").
            Where("u.username=?", username).
            Scan(&user)
        if !user.IsSuperuser {
            c.AbortWithStatusJSON(403, gin.H{"code": 403, "msg": "无权限"})
            return
        }
        c.Next()
    }
}
```

#### 新系统（go-noah）
- **权限检查方式**：`middleware.AuthMiddleware(e)` 基于 Casbin RBAC
- **检查逻辑**：通过 Casbin 策略检查用户是否有相应 API 权限
- **代码位置**：`go-noah/internal/middleware/rbac.go`
- **特点**：
  - 基于角色的访问控制（RBAC）
  - 支持角色继承
  - 权限控制粒度细，可按 API 级别控制
  - 支持 `admin` 角色和 `dba` 角色管理环境

```go
// 新系统权限检查
func AuthMiddleware(e *casbin.SyncedEnforcer) gin.HandlerFunc {
    return func(ctx *gin.Context) {
        // 用户ID=1 或拥有 admin 角色，跳过权限检查
        if uidStr == model.AdminUserID {
            ctx.Next()
            return
        }
        
        // 检查用户是否有 admin 角色
        roles, _ := e.GetRolesForUser(uidStr)
        for _, role := range roles {
            if role == model.AdminRole {
                ctx.Next()
                return
            }
        }
        
        // 通过 Casbin 检查 API 权限
        allowed, _ := e.Enforce(sub, obj, act)
        if !allowed {
            api.HandleError(ctx, http.StatusForbidden, api.ErrForbidden, nil)
            ctx.Abort()
            return
        }
        ctx.Next()
    }
}
```

### 2.3 数据模型差异

#### 老系统（goinsight）
- **表名**：`insight_db_environments`
- **模型**：`InsightDBEnvironments`
- **字段**：
  - `id` (主键)
  - `name` (环境名，唯一索引)
  - `created_at`
  - `updated_at`

#### 新系统（go-noah）
- **表名**：`db_environments`
- **模型**：`DBEnvironment`
- **字段**：
  - `id` (主键，gorm.Model)
  - `name` (环境名，唯一索引)
  - `created_at` (gorm.Model)
  - `updated_at` (gorm.Model)
  - `deleted_at` (软删除，gorm.Model)

**主要差异**：新系统支持软删除（`deleted_at`）

---

## 三、数据库配置管理差异

### 3.1 API 端点对比

| 功能 | 老系统（goinsight） | 新系统（go-noah） |
|------|-------------------|------------------|
| **获取数据库配置列表** | `GET /api/v1/admin/dbconfig` | `GET /api/v1/insight/dbconfigs` |
| **获取单个数据库配置** | `GET /api/v1/admin/dbconfig/:id` | `GET /api/v1/insight/dbconfigs/:instance_id` |
| **创建数据库配置** | `POST /api/v1/admin/dbconfig` | `POST /api/v1/insight/dbconfigs` |
| **更新数据库配置** | `PUT /api/v1/admin/dbconfig/:id` | `PUT /api/v1/insight/dbconfigs/:id` |
| **删除数据库配置** | `DELETE /api/v1/admin/dbconfig/:id` | `DELETE /api/v1/insight/dbconfigs/:id` |
| **获取实例下的 Schemas** | 无单独接口 | `GET /api/v1/insight/dbconfigs/:instance_id/schemas` |

### 3.2 权限控制差异

#### 老系统（goinsight）
- **权限检查**：`middleware.HasAdminPermission()` - 检查 `IsSuperuser`
- **特点**：只有超级管理员可以管理数据库配置

#### 新系统（go-noah）
- **权限检查**：`middleware.AuthMiddleware(e)` - 基于 Casbin RBAC
- **特点**：
  - 支持 `admin` 和 `dba` 角色管理数据库配置
  - 可以通过 Casbin 策略灵活配置权限

### 3.3 数据模型差异

#### 老系统（goinsight）
- **表名**：`insight_db_config`
- **模型**：`InsightDBConfig`
- **主要字段**：
  - `instance_id` (UUID, 唯一索引)
  - `hostname` + `port` + `use_type` (联合唯一索引)
  - `user_name`, `password`
  - `use_type` (ENUM: '查询', '工单')
  - `db_type` (ENUM: 'MySQL', 'TiDB', 'ClickHouse')
  - `environment` (int, 关联环境ID)
  - `inspect_params` (JSON)
  - `organization_key`, `organization_path` (JSON)

#### 新系统（go-noah）
- **表名**：`db_configs`
- **模型**：`DBConfig`
- **主要字段**：
  - `instance_id` (UUID, 唯一索引)
  - `hostname` + `port` (联合唯一索引，**注意**：不包含 `use_type`)
  - `user_name`, `password` (**注意**：字段名是 `user_name`，不是 `user_name`)
  - `use_type` (VARCHAR: '查询', '工单')
  - `db_type` (VARCHAR: 'MySQL', 'TiDB', 'ClickHouse')
  - `environment` (int, 关联环境ID)
  - `inspect_params` (JSON)
  - `organization_key`, `organization_path` (JSON)
  - `deleted_at` (软删除)

**主要差异**：
1. **唯一索引差异**：老系统的唯一索引包含 `use_type`，新系统不包含（同一个 `hostname:port` 只能有一个配置）
2. **字段类型差异**：老系统使用 `ENUM`，新系统使用 `VARCHAR`
3. **软删除**：新系统支持软删除

---

## 四、权限分配差异

### 4.1 DAS 权限授权对比

#### 老系统（goinsight）

**API 端点**：
- `GET /api/v1/das/admin/schemas/grant` - 获取库权限列表
- `POST /api/v1/das/admin/schemas/grant` - 授权库权限
- `DELETE /api/v1/das/admin/schemas/grant/:id` - 撤销库权限
- `GET /api/v1/das/admin/tables/grant` - 获取表权限列表
- `POST /api/v1/das/admin/tables/grant` - 授权表权限
- `DELETE /api/v1/das/admin/tables/grant/:id` - 撤销表权限

**权限检查**：
- 需要 `middleware.HasAdminPermission()` - 检查 `IsSuperuser`

**数据模型**：
- `insight_das_user_schema_permissions` - 库权限表
  - `username` + `schema` + `instance_id` (联合唯一索引)
- `insight_das_user_table_permissions` - 表权限表
  - `username` + `schema` + `table` + `instance_id` (联合唯一索引)
  - `rule` (ENUM: 'allow', 'deny')

**权限逻辑**：
- 基于用户名直接授权
- 支持 allow/deny 规则
- 优先级：allow > deny

#### 新系统（go-noah）

**API 端点**：
- `GET /api/v1/insight/das/permissions` - 获取用户权限列表
- `POST /api/v1/insight/das/permissions/schema` - 授权库权限
- `DELETE /api/v1/insight/das/permissions/schema/:id` - 撤销库权限
- 表权限授权接口（待实现或不同实现方式）

**权限检查**：
- 需要 `middleware.AuthMiddleware(e)` - 基于 Casbin RBAC
- 支持 `admin` 和 `dba` 角色授权

**数据模型**：
- `das_user_schema_permissions` - 库权限表（结构与老系统相同）
- `das_user_table_permissions` - 表权限表（结构与老系统相同）
- `rule` (VARCHAR: 'allow', 'deny')

**权限逻辑**：
- 基于用户名直接授权（与老系统相同）
- 支持 allow/deny 规则（与老系统相同）
- 优先级：allow > deny（与老系统相同）

### 4.2 系统级权限控制差异

#### 老系统（goinsight）

**权限体系**：
- **超级管理员**：`IsSuperuser = true` 的用户
- **普通用户**：`IsSuperuser = false` 的用户

**权限检查方式**：
- 中间件检查 `IsSuperuser` 字段
- 简单的布尔值判断
- 只有两种角色：超级管理员和普通用户

**特点**：
- 权限控制简单直接
- 不支持角色继承
- 权限粒度粗（要么全部权限，要么没有权限）

#### 新系统（go-noah）

**权限体系**：
- **超级管理员**：用户ID=1 或拥有 `admin` 角色的用户
- **DBA**：拥有 `dba` 角色的用户
- **开发人员**：拥有 `developer` 角色的用户
- **运营人员**：拥有 `1000` 角色的用户
- **访客**：拥有 `1001` 角色的用户

**权限检查方式**：
- 基于 Casbin RBAC 的权限策略
- 支持角色继承
- 按 API 级别细粒度控制

**特点**：
- 灵活的权限配置
- 支持角色继承（如：DBA 继承开发人员权限）
- 权限粒度细（可按 API、菜单级别控制）
- 支持部门管理（数据范围隔离）

### 4.3 组织管理差异

#### 老系统（goinsight）
- **组织管理**：存在 `insight_organizations` 和 `insight_organizations_users` 表
- **用途**：用于工单审批流程中的组织关系
- **权限管理**：不直接用于权限控制，仅用于数据关联

#### 新系统（go-noah）
- **组织管理**：`organizations` 和 `organization_users` 表（已迁移）
- **部门管理**：新增 `departments` 和 `role_departments` 表
- **用途**：
  - 组织关系：用于工单审批流程（与老系统相同）
  - 部门管理：支持数据范围隔离（新功能）
- **权限管理**：支持基于部门的数据范围控制（规划中）

---

## 五、功能对比总结

### 5.1 环境管理

| 特性 | 老系统 | 新系统 |
|------|--------|--------|
| **API 路径** | `/api/v1/admin/environment` | `/api/v1/insight/environments` |
| **权限控制** | 仅超级管理员 | admin、dba 角色 |
| **软删除** | ❌ 不支持 | ✅ 支持 |
| **权限粒度** | 粗（全部/无） | 细（API级别） |

### 5.2 数据库配置管理

| 特性 | 老系统 | 新系统 |
|------|--------|--------|
| **API 路径** | `/api/v1/admin/dbconfig` | `/api/v1/insight/dbconfigs` |
| **权限控制** | 仅超级管理员 | admin、dba 角色 |
| **唯一索引** | `hostname + port + use_type` | `hostname + port` |
| **字段类型** | ENUM | VARCHAR |
| **软删除** | ❌ 不支持 | ✅ 支持 |
| **Schemas 接口** | ❌ 无单独接口 | ✅ 支持 |

### 5.3 权限分配

| 特性 | 老系统 | 新系统 |
|------|--------|--------|
| **DAS 权限 API** | `/api/v1/das/admin/*/grant` | `/api/v1/insight/das/permissions/*` |
| **权限检查** | `IsSuperuser` | Casbin RBAC |
| **角色体系** | 超级管理员/普通用户 | admin/dba/developer/运营/访客 |
| **角色继承** | ❌ 不支持 | ✅ 支持 |
| **权限粒度** | 粗（全部/无） | 细（API级别） |
| **部门管理** | ❌ 无 | ✅ 支持（规划中） |
| **数据范围控制** | ❌ 无 | ✅ 支持（规划中） |

---

## 六、迁移建议

### 6.1 API 路径迁移

**前端需要更新的 API 端点**：
1. 环境管理：`/api/v1/admin/environment` → `/api/v1/insight/environments`
2. 数据库配置：`/api/v1/admin/dbconfig` → `/api/v1/insight/dbconfigs`
3. DAS 权限授权：`/api/v1/das/admin/schemas/grant` → `/api/v1/insight/das/permissions/schema`

### 6.2 权限配置迁移

**需要为管理员用户配置 Casbin 策略**：
```csv
# 角色绑定
g, <user_id>, admin  # 将用户ID绑定到 admin 角色
g, <user_id>, dba    # 或将用户ID绑定到 dba 角色

# API 权限
p, admin, api:/v1/insight/environments, GET
p, admin, api:/v1/insight/environments, POST
p, admin, api:/v1/insight/environments, PUT
p, admin, api:/v1/insight/environments, DELETE

p, admin, api:/v1/insight/dbconfigs, GET
p, admin, api:/v1/insight/dbconfigs, POST
p, admin, api:/v1/insight/dbconfigs, PUT
p, admin, api:/v1/insight/dbconfigs, DELETE

p, dba, api:/v1/insight/environments, GET
p, dba, api:/v1/insight/environments, POST
p, dba, api:/v1/insight/dbconfigs, GET
p, dba, api:/v1/insight/dbconfigs, POST
```

### 6.3 数据迁移注意事项

1. **数据库配置唯一索引**：
   - 老系统：`hostname + port + use_type` 联合唯一
   - 新系统：`hostname + port` 联合唯一
   - **迁移时需要注意**：如果老系统存在同一个 `hostname:port` 的不同 `use_type` 配置，需要合并或重命名

2. **软删除支持**：
   - 新系统支持软删除，迁移时需要考虑 `deleted_at` 字段

3. **字段类型**：
   - ENUM → VARCHAR 迁移通常没问题，但需要验证数据一致性

---

## 七、新系统优势

1. **更灵活的权限控制**：
   - 基于角色的访问控制（RBAC）
   - 支持角色继承
   - 细粒度的权限管理（API级别）

2. **更好的扩展性**：
   - 支持部门管理
   - 支持数据范围隔离（规划中）
   - 易于添加新角色和权限

3. **更规范的设计**：
   - 统一的 API 路径规范（`/api/v1/insight/*`）
   - 软删除支持
   - 更清晰的代码结构

---

## 八、需要关注的问题

1. **API 路径变更**：前端需要更新所有相关的 API 调用
2. **权限配置**：需要为现有管理员用户配置 Casbin 角色和权限策略
3. **数据库配置唯一索引**：迁移时需要注意同一 `hostname:port` 的配置冲突
4. **表权限授权接口**：新系统的表权限授权接口可能还未完全实现，需要确认

---

## 九、后续工作建议

1. **完善权限授权功能**：
   - 确认表权限授权接口的实现情况
   - 提供权限授权的管理界面

2. **权限策略初始化**：
   - 在迁移脚本中自动为超级管理员用户配置 admin 角色和权限
   - 提供权限策略的批量配置工具

3. **文档完善**：
   - 提供权限配置的详细文档
   - 提供 API 迁移指南


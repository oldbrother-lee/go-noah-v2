# 数据库权限绑定流程说明

## 一、权限绑定架构

数据库权限采用**基于角色的访问控制（RBAC）**模式，权限绑定流程如下：

```
权限模板/权限组 → 角色权限表 → 角色 → 用户（通过Casbin）
```

**核心概念：**
- **权限模板**：预定义的权限组合（实例+库+表）
- **权限组**：预定义的数据库组合（实例+库）
- **角色权限**：将权限模板/权限组/直接权限对象绑定到角色
- **用户角色**：通过Casbin系统将用户绑定到角色

---

## 二、完整绑定流程

### 步骤1：创建权限模板或权限组

#### 1.1 创建权限模板

**路径**：`系统管理` → `数据库管理` → `权限管理` → `权限模板`

**操作**：
1. 点击"新增"按钮
2. 填写模板名称和描述
3. 添加权限配置（实例+库+可选表）
4. 保存

**示例**：创建"开发环境所有库"模板
```json
[
  {"instance_id": "dev-instance-uuid", "schema": "db1"},
  {"instance_id": "dev-instance-uuid", "schema": "db2"},
  {"instance_id": "dev-instance-uuid", "schema": "db3"}
]
```

#### 1.2 创建权限组

**路径**：`系统管理` → `数据库管理` → `权限管理` → `权限组`

**操作**：
1. 点击"新增"按钮
2. 填写权限组名称和描述
3. 添加数据库列表（实例+库）
4. 保存

**示例**：创建"公共库组"
```json
[
  {"instance_id": "prod-instance-uuid", "schema": "public_db1"},
  {"instance_id": "prod-instance-uuid", "schema": "public_db2"}
]
```

---

### 步骤2：将权限模板/组绑定到角色

**路径**：`系统管理` → `数据库管理` → `权限管理` → `角色权限`

**操作**：
1. 选择角色（下拉选择框）
2. 点击"新增"按钮
3. 选择权限类型：
   - **权限模板**：选择已创建的权限模板
   - **权限组**：选择已创建的权限组
   - **直接权限**：直接配置实例+库+表
4. 保存

**说明**：
- 一个角色可以绑定多个权限模板、多个权限组、多个直接权限对象
- 系统会自动展开模板和组，合并所有权限

---

### 步骤3：给用户分配角色

**路径**：`系统管理` → `用户管理`

**操作**：
1. 选择用户，点击"编辑"按钮
2. 在"角色"字段中选择一个或多个角色
3. 保存

**说明**：
- 一个用户可以拥有多个角色
- 用户的所有角色权限会被合并

---

### 步骤4：系统自动计算用户权限

**权限计算流程**：
```
1. 获取用户的所有角色（从Casbin）
   ↓
2. 获取每个角色的权限（从das_role_permissions表）
   ↓
3. 展开权限模板和权限组
   - 权限模板 → 展开为具体权限对象列表
   - 权限组 → 展开为具体权限对象列表
   - 直接权限对象 → 直接使用
   ↓
4. 合并所有角色的权限（去重）
   ↓
5. 返回用户最终生效的权限列表
```

**权限检查**：
- 用户查询数据时，系统会检查用户是否有对应实例+库+表的权限
- 权限检查基于展开后的最终权限列表

---

## 三、实际使用示例

### 示例1：为开发团队批量授权

**场景**：为10个开发人员授予开发环境所有库的查询权限

**操作步骤**：

1. **创建权限模板**
   - 进入"权限模板管理"
   - 创建模板："开发环境所有库"
   - 添加开发环境的所有数据库

2. **绑定到角色**
   - 进入"角色权限管理"
   - 选择角色："developer"
   - 添加权限，选择权限类型："权限模板"
   - 选择模板："开发环境所有库"

3. **分配角色给用户**
   - 进入"用户管理"
   - 为10个用户分别编辑，分配"developer"角色

**优势**：
- ✅ 只需配置一次权限模板
- ✅ 后续新用户只需添加到角色即可
- ✅ 权限变更只需修改模板，所有用户自动生效

---

### 示例2：为所有用户授予公共库权限

**场景**：为所有用户授予公共库的查询权限

**操作步骤**：

1. **创建权限组**
   - 进入"权限组管理"
   - 创建权限组："公共库组"
   - 添加公共库列表

2. **绑定到默认角色**
   - 进入"角色权限管理"
   - 选择角色："guest"（或创建"public"角色）
   - 添加权限，选择权限类型："权限组"
   - 选择权限组："公共库组"

3. **所有用户默认拥有该角色**
   - 系统初始化时，所有用户默认拥有"guest"角色
   - 或者手动为所有用户分配该角色

---

### 示例3：为特定用户授予特殊权限

**场景**：为某个用户授予特定数据库的查询权限

**操作步骤**：

1. **创建角色（可选）**
   - 如果已有合适的角色，跳过此步
   - 否则，在"角色管理"中创建新角色

2. **绑定直接权限**
   - 进入"角色权限管理"
   - 选择角色
   - 添加权限，选择权限类型："直接权限"
   - 配置实例+库+表

3. **分配角色给用户**
   - 进入"用户管理"
   - 编辑用户，分配该角色

---

## 四、权限查看

### 查看用户实际生效的权限

**路径**：`系统管理` → `数据库管理` → `权限管理` → `用户权限`

**操作**：
1. 选择用户（下拉选择框）
2. 系统自动显示该用户的所有权限
3. 权限列表是展开后的最终权限（已合并所有角色的权限）

**说明**：
- 权限列表会显示每个权限的来源（来自哪个角色、哪个模板/组）
- 支持查看权限的详细信息

---

## 五、常见问题

### Q1: 权限模板和权限组有什么区别？

**权限模板**：
- 可以配置表级别的权限（实例+库+表）
- 适用于需要精确控制表访问的场景

**权限组**：
- 只能配置库级别的权限（实例+库）
- 适用于批量授权整个库的场景

### Q2: 用户有多个角色，权限如何合并？

**答案**：系统会自动合并用户所有角色的权限，并去重。

**示例**：
- 用户A拥有角色"developer"和"dba"
- "developer"角色有权限：`{instance1, db1}`, `{instance1, db2}`
- "dba"角色有权限：`{instance1, db1}`, `{instance1, db3}`
- 用户A最终权限：`{instance1, db1}`, `{instance1, db2}`, `{instance1, db3}`（自动去重）

### Q3: 修改权限模板后，用户权限会自动更新吗？

**答案**：是的。权限是实时计算的，修改权限模板后，所有关联该模板的角色和用户权限会自动更新。

### Q4: 如何撤销用户的某个权限？

**操作方式**：
1. **方式1（推荐）**：从角色中删除对应的权限绑定
   - 进入"角色权限管理"
   - 选择角色，删除对应的权限记录

2. **方式2**：从用户中移除角色
   - 进入"用户管理"
   - 编辑用户，取消勾选对应的角色

### Q5: 权限模板和权限组可以嵌套吗？

**答案**：目前不支持嵌套。权限模板和权限组是平级的，不能相互引用。

---

## 六、数据表说明

### 核心数据表

1. **`das_permission_templates`**：权限模板表
   - 存储权限模板的基本信息和权限配置

2. **`das_permission_groups`**：权限组表
   - 存储权限组的基本信息和数据库列表

3. **`das_role_permissions`**：角色权限表
   - 存储角色与权限的关联关系（模板/组/直接权限对象）

4. **`casbin_rule`**：用户角色关联表（Casbin系统）
   - 存储用户与角色的关联关系（格式：`g, user_id, role`）

---

## 七、权限计算代码位置

### 后端代码

- **权限展开逻辑**：`go-noah/internal/repository/insight/das_permission.go`
  - `ExpandRolePermissions`：展开角色权限
  - `GetUserEffectivePermissions`：获取用户实际生效的权限

- **权限检查逻辑**：`go-noah/internal/handler/insight/das.go`
  - `ExecuteQuery`：执行查询时检查权限
  - `GetUserSchemas`：获取用户可访问的库列表

### 前端代码

- **权限模板管理**：`web/src/views/system/database/permission/template/`
- **权限组管理**：`web/src/views/system/database/permission/group/`
- **角色权限管理**：`web/src/views/system/database/permission/role/`
- **用户权限查看**：`web/src/views/system/database/permission/user/`
- **用户管理**：`web/src/views/system/user/`

---

## 八、总结

**权限绑定流程**：
```
权限模板/权限组 → 角色权限管理 → 角色 → 用户管理 → 用户
```

**关键点**：
1. ✅ 权限模板和权限组必须先创建
2. ✅ 通过"角色权限管理"将模板/组绑定到角色
3. ✅ 通过"用户管理"给用户分配角色
4. ✅ 系统自动计算用户最终权限（展开+合并）

**优势**：
- 🚀 批量授权：一次配置，多人使用
- 🔄 灵活变更：修改模板/组，所有用户自动生效
- 📊 权限清晰：可以查看用户的实际生效权限
- 🛡️ 安全可控：基于角色的权限管理，易于审计


# 工单执行逻辑差异分析

## 一、执行方式差异

### 1.1 老系统（goInsight）

**DDL 执行逻辑：**
- **ALTER TABLE 语句**：使用 `gh-ost` 在线执行（避免锁表）
- **其他 DDL**（CREATE/DROP/TRUNCATE/RENAME）：直接执行

**执行流程：**
```
1. 解析 SQL 类型（GetSqlStatement）
   ├─ 如果是 ALTER TABLE → ExecuteDDLWithGhost（使用 gh-ost）
   └─ 其他 DDL → ExecuteOnlineDDL（直接执行）

2. ALTER TABLE 执行流程：
   ├─ 提取表名（GetTableNameFromAlterStatement）
   ├─ 正则匹配提取 ALTER 子句
   ├─ 生成 gh-ost 命令
   └─ 执行 gh-ost 命令并实时推送日志

3. 其他 DDL 执行流程：
   ├─ 连接数据库
   ├─ 获取 Connection ID
   ├─ 启动进程监控（SHOW PROCESSLIST）
   └─ 执行 SQL
```

### 1.2 新系统（go-noah）

**当前实现：**
- **所有 DDL**：直接执行（`db.ExecContext`）
- **未使用 gh-ost**
- **缺少进程监控**

**问题：**
- ALTER TABLE 语句会锁表，影响业务
- 没有使用在线 DDL 工具，无法避免锁表
- 执行大表 ALTER 时可能长时间阻塞

## 二、gh-ost 工具说明

### 2.1 什么是 gh-ost？

`gh-ost` 是 GitHub 开源的 MySQL 在线 DDL 变更工具，用于执行 ALTER TABLE 操作而无需锁表。

### 2.2 优势

1. **零锁表**：通过创建临时表和行复制实现在线变更
2. **可控性**：可以随时暂停、恢复、取消操作
3. **安全性**：自动验证变更，支持回滚
4. **实时监控**：提供详细的执行进度和统计信息

### 2.3 使用场景

- 修改表结构（ADD/CHANGE/MODIFY/DROP COLUMN）
- 添加/删除索引
- 修改表选项（ENGINE, CHARSET 等）

**不支持的操作：**
- CREATE/DROP TABLE
- TRUNCATE TABLE
- RENAME TABLE（需要转换为 ALTER TABLE ... RENAME）

## 三、需要实现的改进

### 3.1 配置支持

添加 gh-ost 配置到配置文件：

```yaml
ghost:
  path: "/path/to/gh-ost"  # gh-ost 工具路径
  args:                     # gh-ost 参数
    - "--allow-on-master"
    - "--assume-rbr"
    - "--initially-drop-ghost-table"
    - "--initially-drop-old-table"
    - "-initially-drop-socket-file"
```

### 3.2 代码改进

1. **添加 SQL 类型解析**
   - 实现 `GetSqlStatement` 函数（判断 SQL 类型）
   - 实现 `GetTableNameFromAlterStatement` 函数（提取表名）

2. **修改 DDL 执行逻辑**
   - 区分 ALTER TABLE 和其他 DDL
   - ALTER TABLE → 使用 gh-ost 执行
   - 其他 DDL → 直接执行

3. **实现 gh-ost 执行器**
   - 解析 ALTER 子句（正则匹配）
   - 生成 gh-ost 命令
   - 执行命令并实时推送日志
   - 处理阿里云 RDS 特殊参数

4. **添加命令执行工具**
   - 实现 `ExecuteCommand` 函数
   - 支持实时输出和 WebSocket 推送

### 3.3 进程监控（可选）

老系统有进程监控功能（`SHOW PROCESSLIST`），用于监控 SQL 执行状态。新系统可以后续添加。

## 四、实现计划

### 第一阶段：基础支持
1. ✅ 添加配置结构体和配置项
2. ✅ 实现 SQL 类型解析函数
3. ✅ 修改 DDL 执行逻辑，区分 ALTER TABLE

### 第二阶段：gh-ost 集成
1. ✅ 实现 gh-ost 命令生成
2. ✅ 实现命令执行和日志推送
3. ✅ 支持阿里云 RDS 参数

### 第三阶段：优化（可选）
1. 添加进程监控
2. 支持 gh-ost 进度统计
3. 错误处理和回滚逻辑


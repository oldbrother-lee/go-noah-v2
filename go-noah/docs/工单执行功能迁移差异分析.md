# 工单执行功能迁移差异分析

## 一、当前缺失功能

### 1. 权限检查 ❌
**老服务**：`checkOrderStatus` 函数检查：
- 工单是否存在
- 当前用户是否在 `executor` 列表中（执行权限）
- 工单状态是否为"已批准"或"执行中"

**新服务**：只检查了工单状态，**没有检查执行权限**

### 2. 任务状态检查 ❌
**老服务**：
- `checkTasksProgressIsDoing`: 检查是否有任务正在执行中（避免并发执行）
- `checkTasksProgressIsPause`: 检查是否有已暂停的任务

**新服务**：**完全没有这些检查**

### 3. 单个任务执行缺失逻辑 ❌
**老服务**：
- 检查任务是否已完成（避免重复执行）
- 检查任务是否正在执行中（避免重复执行）
- 检查是否有其他任务正在执行中（避免跳过执行中的任务执行其他任务）
- 使用事务同时更新任务状态和工单状态

**新服务**：**没有这些检查**

### 4. 批量执行任务缺失逻辑 ❌
**老服务**：
- 检查是否有任务正在执行中
- 检查是否有已暂停的任务
- 执行完成后更新工单的 `execute_result` 字段

**新服务**：**没有这些检查，也没有更新 `execute_result`**

### 5. 工单状态自动更新 ❌
**老服务**：`updateOrderStatusToFinish` 函数：
- 检查所有任务是否都已完成
- 如果完成，更新工单状态为"已完成"
- 发送通知消息给申请人

**新服务**：**只在批量执行成功时更新，没有检查所有任务是否完成**

### 6. 导出文件通知 ⚠️（可选）
**老服务**：`sendExportFileInfoToApplicant` 函数在导出任务完成后发送通知

**新服务**：**没有实现**

## 二、功能对比表

| 功能 | 老服务 | 新服务 | 状态 |
|------|--------|--------|------|
| 执行权限检查 | ✅ | ❌ | 缺失 |
| 任务执行中检查 | ✅ | ❌ | 缺失 |
| 任务已暂停检查 | ✅ | ❌ | 缺失 |
| 单个任务重复执行检查 | ✅ | ❌ | 缺失 |
| 事务更新任务和工单状态 | ✅ | ❌ | 缺失 |
| 工单状态自动更新 | ✅ | ❌ | 缺失 |
| 执行结果字段更新 | ✅ | ❌ | 缺失 |
| 导出文件通知 | ✅ | ❌ | 缺失（可选） |
| WebSocket 推送 | ✅ | ✅ | 已实现 |

## 三、修复优先级

### 高优先级（必须修复）
1. ✅ **已修复** 执行权限检查
2. ✅ **已修复** 任务状态检查（执行中、已暂停）
3. ✅ **已修复** 单个任务重复执行检查
4. ✅ **已修复** 工单状态自动更新
5. ✅ **已修复** 执行结果字段更新

### 中优先级（建议修复）
6. ✅ **已修复** 事务更新任务和工单状态

### 低优先级（可选）
7. ⚠️ 导出文件通知（暂时未实现，需要通知服务）

## 四、已修复内容

### 1. 权限检查 ✅
- 添加了 `checkOrderStatus` 函数，检查：
  - 工单是否存在
  - 当前用户是否在 `executor` 列表中
  - 工单状态是否为"已批准"或"执行中"

### 2. 任务状态检查 ✅
- 添加了 `CheckTasksProgressIsDoing` 方法：检查是否有任务正在执行中
- 添加了 `CheckTasksProgressIsPause` 方法：检查是否有已暂停的任务

### 3. 单个任务执行逻辑 ✅
- 检查任务是否已完成或正在执行中（避免重复执行）
- 检查是否有其他任务正在执行中
- 使用事务同时更新任务状态和工单状态

### 4. 批量执行任务逻辑 ✅
- 检查是否有任务正在执行中
- 检查是否有已暂停的任务
- 执行完成后更新工单的 `execute_result` 字段

### 5. 工单状态自动更新 ✅
- 添加了 `updateOrderStatusToFinish` 函数：
  - 检查所有任务是否都已完成
  - 如果完成，更新工单状态为"已完成"
  - 通知功能暂时未实现（需要通知服务）

### 6. 事务更新 ✅
- 添加了 `UpdateTaskAndOrderProgress` 方法，使用事务同时更新任务和工单状态

## 五、剩余工作

### 可选功能
- ⚠️ 导出文件通知：需要实现 `sendExportFileInfoToApplicant` 功能（依赖通知服务）
- ⚠️ 工单完成通知：需要在 `updateOrderStatusToFinish` 中添加通知功能（依赖通知服务）


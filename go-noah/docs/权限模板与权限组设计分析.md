# 权限模板与权限组设计分析

## 一、当前设计对比

### 权限模板（Permission Template）

**数据结构**：
```go
PermissionObject {
    InstanceID string  // 实例ID
    Schema     string  // 库名
    Table      string  // 表名（可选）
}
```

**功能**：
- ✅ 支持库级别权限（`table` 为空）
- ✅ 支持表级别权限（`table` 不为空）
- ✅ 可以混合配置（部分库级别，部分表级别）

**示例**：
```json
[
  {"instance_id": "uuid1", "schema": "db1"},                    // 库级别
  {"instance_id": "uuid1", "schema": "db2", "table": "t1"},    // 表级别
  {"instance_id": "uuid2", "schema": "db3"}                    // 库级别
]
```

---

### 权限组（Permission Group）

**数据结构**：
```go
DatabaseObject {
    InstanceID string  // 实例ID
    Schema     string  // 库名
}
```

**功能**：
- ✅ 仅支持库级别权限
- ❌ 不支持表级别权限

**示例**：
```json
[
  {"instance_id": "uuid1", "schema": "db1"},
  {"instance_id": "uuid1", "schema": "db2"},
  {"instance_id": "uuid2", "schema": "db3"}
]
```

---

## 二、问题分析

### 2.1 功能重复

**权限模板完全可以覆盖权限组的功能**：
- 当权限模板中所有权限对象的 `table` 字段都为空时，功能等同于权限组
- 权限模板更灵活，可以同时支持库级别和表级别

### 2.2 设计复杂度

**当前设计的问题**：
1. **概念重复**：两个概念功能重叠，增加学习成本
2. **代码重复**：需要维护两套相似的数据模型、API、前端页面
3. **选择困难**：用户不知道什么时候用模板，什么时候用组
4. **维护成本**：两套代码需要同步维护

### 2.3 实际使用场景

**权限组的使用场景**：
- 批量授权多个库（实例+库）
- 这种情况完全可以用权限模板实现（table字段留空）

**权限模板的使用场景**：
- 批量授权多个库（实例+库）✅
- 批量授权多个表（实例+库+表）✅
- 混合授权（部分库级别，部分表级别）✅

**结论**：权限模板可以完全覆盖权限组的所有使用场景。

---

## 三、简化方案

### 方案1：合并为权限模板（推荐）⭐

**方案**：
- ✅ 保留权限模板，删除权限组
- ✅ 权限模板支持库级别（table为空）和表级别（table不为空）
- ✅ 简化角色权限类型：`object`、`template`（删除 `group`）

**优势**：
1. **简化设计**：减少一个概念，降低学习成本
2. **代码精简**：删除权限组相关代码（模型、API、前端）
3. **功能完整**：权限模板可以完全替代权限组
4. **维护简单**：只需维护一套代码

**迁移方案**：
1. 将现有权限组数据迁移到权限模板（table字段留空）
2. 更新角色权限表中的 `permission_type`：`group` → `template`
3. 删除权限组相关代码和表

---

### 方案2：保留两者，明确使用场景

**方案**：
- 保留权限模板和权限组
- 明确使用场景：
  - **权限组**：仅用于库级别批量授权（语义更清晰）
  - **权限模板**：用于需要表级别控制的场景

**优势**：
- 语义更清晰（组=库级别，模板=可包含表级别）

**劣势**：
- 仍然存在功能重复
- 增加维护成本
- 用户选择困难

---

## 四、推荐方案：合并为权限模板

### 4.1 数据模型简化

**删除**：
- `das_permission_groups` 表
- `DASPermissionGroup` 模型
- `DatabaseObject` 类型

**保留**：
- `das_permission_templates` 表
- `DASPermissionTemplate` 模型
- `PermissionObject` 类型（支持可选的 `table` 字段）

### 4.2 角色权限类型简化

**修改前**：
```go
PermissionType {
    Object   = "object"    // 直接权限对象
    Template = "template"  // 权限模板
    Group    = "group"     // 权限组
}
```

**修改后**：
```go
PermissionType {
    Object   = "object"    // 直接权限对象
    Template = "template" // 权限模板（支持库级别和表级别）
}
```

### 4.3 前端界面简化

**删除**：
- 权限组管理页面
- 权限组相关API

**保留**：
- 权限模板管理页面（支持库级别和表级别配置）

**角色权限管理页面**：
- 权限类型选择：`直接权限`、`权限模板`（删除 `权限组` 选项）

---

## 五、实施步骤

### 步骤1：数据迁移

1. **迁移权限组数据到权限模板**
   ```sql
   INSERT INTO das_permission_templates (name, description, permissions, created_at, updated_at)
   SELECT 
       CONCAT(name, '_migrated'),
       description,
       JSON_ARRAYAGG(JSON_OBJECT('instance_id', instance_id, 'schema', schema)),
       created_at,
       updated_at
   FROM das_permission_groups
   GROUP BY id, name, description, created_at, updated_at;
   ```

2. **更新角色权限表**
   ```sql
   -- 将权限组类型的权限改为权限模板类型
   UPDATE das_role_permissions rp
   JOIN das_permission_groups pg ON rp.permission_id = pg.id
   JOIN das_permission_templates pt ON pt.name = CONCAT(pg.name, '_migrated')
   SET rp.permission_type = 'template', rp.permission_id = pt.id
   WHERE rp.permission_type = 'group';
   ```

### 步骤2：代码修改

1. **删除权限组相关代码**
   - 删除 `DASPermissionGroup` 模型
   - 删除权限组相关的 repository、service、handler
   - 删除权限组相关的 API 路由

2. **更新权限展开逻辑**
   - 删除 `PermissionTypeGroup` 的处理逻辑
   - 简化 `ExpandRolePermissions` 函数

3. **更新前端**
   - 删除权限组管理页面
   - 更新角色权限管理页面（删除权限组选项）

### 步骤3：测试验证

1. 验证权限模板可以正常创建（库级别和表级别）
2. 验证角色权限绑定正常
3. 验证用户权限计算正常
4. 验证数据迁移正确

---

## 六、总结

### 当前问题
- ❌ 权限模板和权限组功能重复
- ❌ 增加设计复杂度和维护成本
- ❌ 用户选择困难

### 推荐方案
- ✅ **合并为权限模板**，删除权限组
- ✅ 权限模板支持库级别（table为空）和表级别（table不为空）
- ✅ 简化设计，降低维护成本

### 实施建议
1. **立即实施**：在开发阶段，简化设计更容易
2. **数据迁移**：提供迁移脚本，将现有权限组数据迁移到权限模板
3. **文档更新**：更新相关文档，删除权限组相关内容

---

## 七、对比表

| 特性 | 权限模板 | 权限组 | 合并后（仅模板） |
|------|---------|--------|-----------------|
| 库级别权限 | ✅ | ✅ | ✅ |
| 表级别权限 | ✅ | ❌ | ✅ |
| 混合配置 | ✅ | ❌ | ✅ |
| 代码复杂度 | 中等 | 中等 | **低** |
| 维护成本 | 中等 | 中等 | **低** |
| 学习成本 | 中等 | 中等 | **低** |
| 功能完整性 | ✅ | ⚠️ | ✅ |

**结论**：合并为权限模板是最优方案。


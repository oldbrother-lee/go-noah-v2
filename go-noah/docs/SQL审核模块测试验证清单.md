# SQL审核模块测试验证清单

## ✅ 迁移完成状态

**所有53条审核规则和完整的规则引擎架构已迁移完成！**

## 📋 测试验证清单

### 1. 基础功能测试

#### 1.1 SQL解析测试
- [ ] 测试正常SQL解析
- [ ] 测试语法错误SQL
- [ ] 测试多语句SQL
- [ ] 测试带注释的SQL

#### 1.2 数据库连接测试
- [ ] 测试正常数据库连接
- [ ] 测试数据库不存在（error 1049）
- [ ] 测试表不存在（error 1146）
- [ ] 测试连接失败处理

### 2. AlterTable 规则测试（19条）

#### 2.1 表存在性检查
- [ ] 测试表存在的情况
- [ ] 测试表不存在的情况
- [ ] 测试数据库不存在的情况
- [ ] 测试SQL中指定数据库名的情况

#### 2.2 TiDB合并检查
- [ ] 测试TiDB多操作合并检查

#### 2.3 DROP操作检查
- [ ] 测试DROP列检查
- [ ] 测试DROP索引检查
- [ ] 测试DROP主键检查
- [ ] 测试TiDB覆盖索引检查

#### 2.4 表Options检查
- [ ] 测试字符集检查
- [ ] 测试存储引擎检查
- [ ] 测试行格式检查

#### 2.5 列操作检查
- [ ] 测试列字符集检查
- [ ] 测试Add列After检查
- [ ] 测试Add列Options检查
- [ ] 测试Modify列Options检查
- [ ] 测试Change列Options检查
- [ ] 测试重复列检查

#### 2.6 索引操作检查
- [ ] 测试Add主键检查
- [ ] 测试Add索引前缀检查
- [ ] 测试Add索引数量检查
- [ ] 测试Add重复索引检查
- [ ] 测试Add冗余索引检查
- [ ] 测试BLOB/TEXT索引检查
- [ ] 测试RenameIndex检查
- [ ] 测试索引InnodbLargePrefix检查

#### 2.7 其他检查
- [ ] 测试RenameTblName检查
- [ ] 测试InnoDB行大小检查

### 3. CreateTable 规则测试（19条）

#### 3.1 基础检查
- [ ] 测试表存在性检查
- [ ] 测试CreateTableAs语法检查
- [ ] 测试CreateTableLike语法检查

#### 3.2 表结构检查
- [ ] 测试表Options检查
- [ ] 测试主键检查
- [ ] 测试约束检查
- [ ] 测试审计字段检查

#### 3.3 列检查
- [ ] 测试列Options检查
- [ ] 测试列重复定义检查
- [ ] 测试列字符集检查

#### 3.4 索引检查
- [ ] 测试索引前缀检查
- [ ] 测试索引数量检查
- [ ] 测试索引重复定义检查
- [ ] 测试冗余索引检查
- [ ] 测试BLOB/TEXT索引检查
- [ ] 测试索引InnodbLargePrefix检查

#### 3.5 其他检查
- [ ] 测试InnoDB表RowSize检查
- [ ] 测试InnoDB表RowFormat检查

### 4. DML 规则测试（8条）

- [ ] 测试限制部分表进行语法审核
- [ ] 测试INSERT INTO SELECT语法检查
- [ ] 测试必须要有WHERE条件
- [ ] 测试INSERT必须指定列名
- [ ] 测试不能有LIMIT/ORDERBY/SubQuery
- [ ] 测试JOIN操作必须要有ON语句
- [ ] 测试更新影响行数
- [ ] 测试插入影响行数

### 5. 其他规则测试

#### 5.1 DropTable（2条）
- [ ] 测试DropTable检查
- [ ] 测试TruncateTable检查

#### 5.2 RenameTable（1条）
- [ ] 测试RenameTable检查

#### 5.3 CreateView（1条）
- [ ] 测试CreateView检查

#### 5.4 CreateDatabase（1条）
- [ ] 测试CreateDatabase检查

#### 5.5 AnalyzeTable（1条）
- [ ] 测试AnalyzeTable检查

### 6. 集成测试

#### 6.1 规则引擎集成
- [ ] 测试规则链正确执行
- [ ] 测试IsSkipNextStep功能
- [ ] 测试规则优先级

#### 6.2 返回格式测试
- [ ] 测试ReturnData转换
- [ ] 测试Summary字段
- [ ] 测试Level字段
- [ ] 测试Messages字段

#### 6.3 配置参数测试
- [ ] 测试默认参数
- [ ] 测试自定义参数
- [ ] 测试参数持久化

### 7. 性能测试

- [ ] 测试大量SQL审核性能
- [ ] 测试数据库连接池
- [ ] 测试缓存机制

### 8. 兼容性测试

#### 8.1 与老代码对比
- [ ] 对比相同SQL的审核结果
- [ ] 验证审核结果一致性

#### 8.2 API兼容性
- [ ] 测试API返回格式
- [ ] 测试错误处理
- [ ] 测试HTTP状态码

## 🐛 已知问题

### 1. 表存在性检查
- **问题**：数据库不存在时可能无法正确检测
- **状态**：已修复，需要测试验证
- **修复**：在 `dao.CheckIfTableExists` 中添加了数据库不存在检查（error 1049）

### 2. 日志输出
- **问题**：调试日志中包含敏感信息（密码）
- **状态**：已修复，密码已隐藏为 `***`

## 📝 测试建议

### 优先级1（必须测试）
1. 表存在性检查（数据库不存在、表不存在）
2. AlterTable 基础规则（DROP操作、表Options）
3. CreateTable 基础规则（主键、注释）
4. DML 基础规则（WHERE条件、影响行数）

### 优先级2（重要测试）
1. 索引相关规则
2. 列操作规则
3. 字符集和引擎检查

### 优先级3（可选测试）
1. 高级规则（冗余索引、InnoDB行大小等）
2. 性能测试
3. 边界情况测试

## 🎯 测试方法

### 1. 单元测试
为每个规则编写单元测试，验证规则逻辑。

### 2. 集成测试
测试完整的审核流程，验证规则链执行。

### 3. 对比测试
使用相同的SQL，对比老代码和新代码的审核结果。

### 4. 回归测试
确保修复的问题不再出现。

## 📊 测试结果记录

请在测试时记录：
- 测试用例
- 预期结果
- 实际结果
- 是否通过
- 问题描述（如有）


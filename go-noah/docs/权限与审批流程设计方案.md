# 权限与审批流程设计方案

> 基于 go-noah 现有架构扩展，不改动现有 RBAC 基础设计

## 一、现有架构分析

### 1.1 当前角色体系

| 角色Sid | 角色名称 | 说明 |
|---------|---------|------|
| `admin` | 超级管理员 | 用户ID=1 自动绑定，跳过所有权限检查 |
| `1000` | 运营人员 | 有限的菜单和API权限 |
| `1001` | 访客 | 最小权限 |

### 1.2 现有权限资源

| 资源类型 | 前缀 | 说明 |
|---------|------|------|
| 菜单 | `menu:` | 页面访问权限 |
| API | `api:` | 接口调用权限 |

### 1.3 现有表结构

- `admin_users` - 管理员用户
- `roles` - 角色（Sid + Name）
- `menu` - 菜单
- `api` - API接口
- Casbin `casbin_rule` - 权限策略

## 二、扩展设计目标

1. **保持现有设计不变**：`admin` 继续作为超级管理员
2. **添加业务角色**：DBA、开发人员等
3. **添加部门管理**：支持数据范围隔离
4. **添加审批流程**：工单审批自动化

## 三、角色扩展设计

### 3.1 新增业务角色

```go
// 在 migration.go 的 initialRBAC 中添加
roles := []model.Role{
    {Sid: model.AdminRole, Name: "超级管理员"},  // 保持不变
    {Sid: "dba", Name: "DBA"},                   // 新增
    {Sid: "developer", Name: "开发人员"},         // 新增
    {Sid: "1000", Name: "运营人员"},              // 保持不变
    {Sid: "1001", Name: "访客"},                  // 保持不变
}
```

### 3.2 角色扩展字段

```go
// 扩展现有 Role 结构
type Role struct {
    gorm.Model
    Name        string `json:"name" gorm:"column:name;type:varchar(100);uniqueIndex"`
    Sid         string `json:"sid" gorm:"column:sid;type:varchar(100);uniqueIndex"`
    Description string `json:"description" gorm:"column:description;type:varchar(255)"` // 新增
    DataScope   int8   `json:"data_scope" gorm:"column:data_scope;default:1"`           // 新增
    Sort        int    `json:"sort" gorm:"column:sort;default:0"`                       // 新增
    Status      int8   `json:"status" gorm:"column:status;default:1"`                   // 新增
}
// DataScope: 1-全部数据 2-自定义数据 3-本部门数据 4-本部门及以下 5-仅本人
```

### 3.3 部门/组织表

```go
// Department 部门表（新增）
type Department struct {
    gorm.Model
    ParentID uint   `gorm:"index;default:0"`
    Name     string `gorm:"size:50;not null"`
    Code     string `gorm:"size:50;uniqueIndex"`     // 部门编码
    Path     string `gorm:"size:255;index"`          // 路径 /1/2/3/
    Level    int    `gorm:"default:1"`               // 层级
    Leader   string `gorm:"size:50"`                 // 负责人用户名
    LeaderID uint   `gorm:"index"`                   // 负责人ID
    Sort     int    `gorm:"default:0"`
    Status   int8   `gorm:"default:1"`
}

func (Department) TableName() string {
    return "departments"
}
```

### 3.4 用户部门关联

```go
// 扩展 AdminUser，添加部门关联
type AdminUser struct {
    gorm.Model
    Username string `gorm:"type:varchar(50);not null;uniqueIndex"`
    Nickname string `gorm:"type:varchar(50);not null"`
    Password string `gorm:"type:varchar(255);not null"`
    Email    string `gorm:"type:varchar(100);not null"`
    Phone    string `gorm:"type:varchar(20);not null"`
    DeptID   uint   `gorm:"index;default:0"`                      // 新增：部门ID
    Status   int8   `gorm:"default:1"`                            // 新增：状态
}
```

## 四、审批流程设计

### 4.1 审批流程概念

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   流程定义    │────▶│   流程实例    │────▶│   审批任务    │
│ (FlowDef)    │    │ (FlowInst)   │    │ (FlowTask)   │
└──────────────┘    └──────────────┘    └──────────────┘
       │                   │                    │
       │                   │                    │
       ▼                   ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   流程节点    │    │   流程记录    │    │   抄送记录    │
│ (FlowNode)   │    │ (FlowLog)    │    │  (FlowCC)    │
└──────────────┘    └──────────────┘    └──────────────┘
```

### 4.2 审批流程模型

```go
// FlowDefinition 流程定义
type FlowDefinition struct {
    gorm.Model
    Code        string         `gorm:"uniqueIndex;size:50"`  // 流程编码
    Name        string         `gorm:"size:100"`             // 流程名称
    Type        string         `gorm:"size:50"`              // 业务类型: order_ddl, order_dml, order_export
    Description string         `gorm:"size:500"`
    Version     int            `gorm:"default:1"`            // 版本号
    Status      int8           `gorm:"default:1"`            // 1:启用 0:禁用
    Config      datatypes.JSON `gorm:"type:json"`            // 流程配置JSON
}

// FlowNode 流程节点
type FlowNode struct {
    gorm.Model
    FlowDefID     uint           `gorm:"index"`
    NodeCode      string         `gorm:"size:50"`             // 节点编码
    NodeName      string         `gorm:"size:100"`            // 节点名称
    NodeType      string         `gorm:"size:20"`             // 节点类型
    // NodeType: start/end/approval/cc/condition/parallel/serial
    Sort          int            `gorm:"default:0"`           // 顺序
    ApproverType  string         `gorm:"size:20"`             // 审批人类型
    // ApproverType: user/role/dept_leader/superior/self_select/auto
    ApproverIDs   string         `gorm:"size:500"`            // 审批人ID列表（逗号分隔）
    MultiMode     string         `gorm:"size:20"`             // 多人审批模式
    // MultiMode: any(或签)/all(会签)/sequential(依次)
    RejectAction  string         `gorm:"size:20"`             // 驳回动作
    // RejectAction: to_start/to_prev/to_end
    TimeoutHours  int            `gorm:"default:0"`           // 超时时间(小时)
    TimeoutAction string         `gorm:"size:20"`             // 超时动作: auto_pass/auto_reject/notify
    Conditions    datatypes.JSON `gorm:"type:json"`           // 条件配置JSON
}

// FlowInstance 流程实例
type FlowInstance struct {
    gorm.Model
    FlowDefID     uint           `gorm:"index"`
    BusinessType  string         `gorm:"size:50;index"`       // 业务类型
    BusinessID    string         `gorm:"size:50;index"`       // 业务ID
    Title         string         `gorm:"size:200"`            // 流程标题
    InitiatorID   uint           `gorm:"index"`               // 发起人ID
    Initiator     string         `gorm:"size:50"`             // 发起人用户名
    Status        string         `gorm:"size:20;index"`       // 状态
    // Status: pending/running/approved/rejected/cancelled/suspended
    CurrentNodeID uint           `gorm:"index"`               // 当前节点ID
    StartTime     time.Time
    EndTime       *time.Time
    Variables     datatypes.JSON `gorm:"type:json"`           // 流程变量
}

// FlowTask 审批任务
type FlowTask struct {
    gorm.Model
    FlowInstID    uint           `gorm:"index"`
    FlowNodeID    uint           `gorm:"index"`
    AssigneeID    uint           `gorm:"index"`               // 审批人ID
    Assignee      string         `gorm:"size:50"`             // 审批人用户名
    Status        string         `gorm:"size:20;index"`       // 状态
    // Status: pending/approved/rejected/transferred/delegated
    Action        string         `gorm:"size:20"`             // 动作: approve/reject/transfer/delegate
    Comment       string         `gorm:"size:1000"`           // 审批意见
    ActionTime    *time.Time
    DueTime       *time.Time                                  // 截止时间
    TransferTo    uint                                        // 转办给
    DelegateTo    uint                                        // 委托给
}

// FlowLog 流程日志
type FlowLog struct {
    gorm.Model
    FlowInstID   uint   `gorm:"index"`
    FlowNodeID   uint
    NodeName     string `gorm:"size:100"`
    OperatorID   uint
    Operator     string `gorm:"size:50"`
    Action       string `gorm:"size:50"`                      // 动作描述
    Comment      string `gorm:"size:1000"`
    Duration     int64                                        // 耗时(秒)
}

// FlowCC 抄送记录
type FlowCC struct {
    gorm.Model
    FlowInstID uint   `gorm:"index"`
    UserID     uint   `gorm:"index"`
    Username   string `gorm:"size:50"`
    IsRead     bool   `gorm:"default:false"`
    ReadTime   *time.Time
}
```

### 4.3 审批流程配置示例

```json
{
  "flow_code": "order_ddl_approval",
  "flow_name": "DDL工单审批流程",
  "nodes": [
    {
      "node_code": "start",
      "node_type": "start",
      "node_name": "开始"
    },
    {
      "node_code": "condition_1",
      "node_type": "condition",
      "node_name": "影响行数判断",
      "conditions": [
        {
          "branch": "branch_1",
          "expr": "affected_rows <= 1000",
          "next_node": "tech_review"
        },
        {
          "branch": "branch_2", 
          "expr": "affected_rows > 1000",
          "next_node": "leader_approval"
        }
      ]
    },
    {
      "node_code": "tech_review",
      "node_type": "approval",
      "node_name": "技术审核",
      "approver_type": "role",
      "approver_ids": "dba",
      "multi_mode": "any",
      "next_node": "end"
    },
    {
      "node_code": "leader_approval",
      "node_type": "approval", 
      "node_name": "主管审批",
      "approver_type": "dept_leader",
      "multi_mode": "any",
      "next_node": "tech_review"
    },
    {
      "node_code": "end",
      "node_type": "end",
      "node_name": "结束"
    }
  ]
}
```

## 五、角色与权限预设

### 5.1 系统角色体系

| 角色Sid | 角色名称 | 数据范围 | 说明 |
|---------|---------|---------|------|
| `admin` | 超级管理员 | 全部 | **系统最高权限**，用户ID=1自动绑定，跳过权限检查 |
| `dba` | DBA | 全部 | 数据库管理员，可管理所有数据库相关功能 |
| `developer` | 开发人员 | 本部门及以下 | 普通开发权限，可提交工单 |
| `1000` | 运营人员 | 本部门 | 有限的管理权限 |
| `1001` | 访客 | 仅本人 | 只读权限 |

### 5.2 权限矩阵

```
权限点                    admin   dba    developer  运营人员  访客
------------------------------------------------------------------
系统管理
├─ 用户管理               ✓       ✗      ✗          ✗        ✗
├─ 角色管理               ✓       ✗      ✗          ✗        ✗
├─ 部门管理               ✓       ✗      ✗          ✗        ✗
├─ 菜单管理               ✓       ✗      ✗          ✗        ✗
└─ 流程管理               ✓       ✓      ✗          ✗        ✗

数据库管理
├─ 环境管理               ✓       ✓      ✗          ✗        ✗
├─ 实例管理               ✓       ✓      ✗          ✗        ✗
├─ 权限授权               ✓       ✓      ✗          ✗        ✗
└─ 审核参数               ✓       ✓      ✗          ✗        ✗

数据查询
├─ 执行查询               ✓       ✓      ✓          ✓        ✗
├─ 导出数据               ✓       ✓      ✓          ✗        ✗
└─ 查看历史               ✓       ✓      ✓          ✓        ✓

工单管理
├─ 提交工单               ✓       ✓      ✓          ✗        ✗
├─ 审批工单               ✓       ✓      ✗          ✗        ✗
├─ 执行工单               ✓       ✓      ✗          ✗        ✗
└─ 查看工单               ✓       ✓      ✓          ✓        ✓
```

## 六、Casbin 策略配置

### 6.1 现有模型（保持不变）

```ini
[request_definition]
r = sub, obj, act

[policy_definition]
p = sub, obj, act

[role_definition]
g = _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub) && r.obj == p.obj && r.act == p.act
```

### 6.2 策略示例

```csv
# 角色继承（可选，建议扁平化管理）
g, developer, 1001     # 开发人员继承访客权限
g, dba, developer      # DBA继承开发人员权限

# 用户角色绑定（Casbin 自动管理）
g, 1, admin            # 用户ID=1 绑定 admin（已在migration中配置）
g, 2, dba              # 用户ID=2 绑定 dba
g, 3, developer        # 用户ID=3 绑定 developer

# 菜单权限（保持现有格式）
p, admin, menu:/system/user, read
p, admin, menu:/system/role, read
p, admin, menu:/system/menu, read
p, dba, menu:/database/environment, read
p, dba, menu:/database/instance, read
p, developer, menu:/orders/list, read
p, developer, menu:/orders/submit, read
p, 1000, menu:/dashboard, read

# API权限（保持现有格式）
p, admin, api:/v1/admin/users, GET
p, admin, api:/v1/admin/user, POST
p, admin, api:/v1/admin/user, PUT
p, admin, api:/v1/admin/user, DELETE
p, dba, api:/v1/database/environments, GET
p, dba, api:/v1/database/instances, GET
p, developer, api:/v1/orders/commit, POST
p, developer, api:/v1/orders/list, GET
```

### 6.3 权限检查逻辑（保持不变）

```go
// middleware/rbac.go 核心逻辑保持不变
func AuthMiddleware(e *casbin.SyncedEnforcer) gin.HandlerFunc {
    return func(ctx *gin.Context) {
        // 1. 获取用户ID
        uid := getUserID(ctx)
        
        // 2. 超级管理员跳过（用户ID=1 或 角色=admin）
        if uid == model.AdminUserID {
            ctx.Next()
            return
        }
        
        roles, _ := e.GetRolesForUser(uid)
        for _, role := range roles {
            if role == model.AdminRole {  // "admin"
                ctx.Next()
                return
            }
        }
        
        // 3. 普通用户检查权限
        allowed, _ := e.Enforce(uid, resource, action)
        if !allowed {
            ctx.AbortWithStatus(403)
            return
        }
        ctx.Next()
    }
}
```

## 七、API 设计

### 7.1 权限管理 API（扩展现有）

```
# 用户管理
GET    /api/v1/admin/users              # 用户列表
POST   /api/v1/admin/user               # 创建用户
PUT    /api/v1/admin/user/:id           # 更新用户
DELETE /api/v1/admin/user/:id           # 删除用户
PUT    /api/v1/admin/user/:id/status    # 更新状态
PUT    /api/v1/admin/user/:id/password  # 重置密码

# 角色管理
GET    /api/v1/admin/roles              # 角色列表
POST   /api/v1/admin/role               # 创建角色
PUT    /api/v1/admin/role/:id           # 更新角色
DELETE /api/v1/admin/role/:id           # 删除角色
GET    /api/v1/admin/role/:id/permissions  # 获取角色权限
PUT    /api/v1/admin/role/:id/permissions  # 更新角色权限

# 部门管理
GET    /api/v1/admin/departments        # 部门树
POST   /api/v1/admin/department         # 创建部门
PUT    /api/v1/admin/department/:id     # 更新部门
DELETE /api/v1/admin/department/:id     # 删除部门

# 权限管理
GET    /api/v1/admin/permissions        # 权限树
POST   /api/v1/admin/permission         # 创建权限
PUT    /api/v1/admin/permission/:id     # 更新权限
DELETE /api/v1/admin/permission/:id     # 删除权限
```

### 7.2 部门管理 API（新增）

```
GET    /api/v1/admin/departments        # 部门树
POST   /api/v1/admin/department         # 创建部门
PUT    /api/v1/admin/department/:id     # 更新部门
DELETE /api/v1/admin/department/:id     # 删除部门
GET    /api/v1/admin/department/:id/users  # 部门用户列表
```

### 7.3 审批流程 API（新增）

```
# 流程定义
GET    /api/v1/flow/definitions         # 流程定义列表
POST   /api/v1/flow/definition          # 创建流程定义
PUT    /api/v1/flow/definition/:id      # 更新流程定义
DELETE /api/v1/flow/definition/:id      # 删除流程定义
GET    /api/v1/flow/definition/:id/design  # 获取流程设计

# 流程实例
POST   /api/v1/flow/instance/start      # 发起流程
GET    /api/v1/flow/instances           # 我发起的流程
GET    /api/v1/flow/instance/:id        # 流程详情
PUT    /api/v1/flow/instance/:id/cancel # 撤销流程

# 审批任务
GET    /api/v1/flow/tasks/todo          # 待办任务
GET    /api/v1/flow/tasks/done          # 已办任务
POST   /api/v1/flow/task/:id/approve    # 通过
POST   /api/v1/flow/task/:id/reject     # 驳回
POST   /api/v1/flow/task/:id/transfer   # 转办
POST   /api/v1/flow/task/:id/delegate   # 委托

# 抄送
GET    /api/v1/flow/cc                  # 抄送给我的
PUT    /api/v1/flow/cc/:id/read         # 标记已读
```

## 八、前端权限控制

### 8.1 按钮级权限指令

```typescript
// directives/permission.ts
import type { Directive } from 'vue';
import { useAuthStore } from '@/store/modules/auth';

export const permission: Directive = {
  mounted(el, binding) {
    const authStore = useAuthStore();
    const { value } = binding;
    
    if (value && !authStore.hasPermission(value)) {
      el.parentNode?.removeChild(el);
    }
  }
};

// 使用
<n-button v-permission="'btn:user:create'">新增用户</n-button>
```

### 8.2 权限 Store

```typescript
// store/modules/auth.ts
export const useAuthStore = defineStore('auth', {
  state: () => ({
    permissions: [] as string[],
    roles: [] as string[],
    dataScope: 1, // 数据范围
  }),
  
  getters: {
    // 超级管理员判断：角色包含 'admin'
    isAdmin: (state) => state.roles.includes('admin'),
    
    hasPermission: (state) => (permission: string) => {
      // admin 角色拥有所有权限
      if (state.roles.includes('admin')) return true;
      return state.permissions.includes(permission);
    },
    
    hasRole: (state) => (role: string) => {
      return state.roles.includes(role);
    },
    
    hasAnyPermission: (state) => (permissions: string[]) => {
      if (state.roles.includes('admin')) return true;
      return permissions.some(p => state.permissions.includes(p));
    },
    
    hasAnyRole: (state) => (roles: string[]) => {
      return roles.some(r => state.roles.includes(r));
    },
  },
});
```

## 九、实施计划

### 第一阶段：角色扩展（3天）
- [ ] 扩展 Role 表（添加 description, data_scope, sort, status）
- [ ] 添加业务角色初始化（dba, developer）
- [ ] 前端角色管理页面完善

### 第二阶段：部门管理（3天）
- [ ] 创建 Department 表
- [ ] 用户关联部门
- [ ] 部门管理 API 和前端页面

### 第三阶段：数据范围（2天）
- [ ] 实现 DataScope 查询过滤
- [ ] 工单列表按部门过滤

### 第四阶段：审批流程（1周）
- [ ] 流程定义模型
- [ ] 流程引擎实现
- [ ] 审批任务管理
- [ ] 与工单系统集成

## 十、现有系统兼容说明

### 关键常量保持不变

```go
// model/admin.go - 保持不变
const (
    AdminRole          = "admin"    // 超级管理员角色
    AdminUserID        = "1"        // 超级管理员用户ID
    MenuResourcePrefix = "menu:"    // 菜单权限前缀
    ApiResourcePrefix  = "api:"     // API权限前缀
    PermSep            = ","        // 权限分隔符
)
```

### 权限检查逻辑不变

- 用户ID=1 → 跳过所有权限检查
- 角色=admin → 跳过所有权限检查
- 其他用户 → Casbin 权限检查

### 不需要数据迁移

新设计是对现有系统的扩展，不是替换：
- 现有用户数据保持不变
- 现有角色保持不变
- 现有权限策略保持不变
- 只是增加了部门管理和审批流程功能


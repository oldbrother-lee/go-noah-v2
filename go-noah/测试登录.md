# 登录功能测试指南

## 一、启动服务器

### 方式 1: 直接运行
```bash
cd go-noah
go run ./cmd/server
```

### 方式 2: 使用 Makefile
```bash
cd go-noah
make bootstrap
```

### 方式 3: 构建后运行
```bash
cd go-noah
go build -o ./bin/server ./cmd/server
./bin/server
```

服务器启动后，默认监听地址：`http://127.0.0.1:8000`

## 二、测试登录接口

### 2.1 使用 curl 命令

**基本登录请求：**
```bash
curl -X POST http://127.0.0.1:8000/v1/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "123456"
  }'
```

**格式化输出（需要安装 jq）：**
```bash
curl -X POST http://127.0.0.1:8000/v1/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "123456"
  }' | jq '.'
```

**成功响应示例：**
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**失败响应示例：**
```json
{
  "code": 401,
  "message": "登录失效，请重新登录~",
  "data": {}
}
```

### 2.2 使用测试脚本

```bash
# 给脚本添加执行权限
chmod +x test_login.sh

# 使用默认用户名和密码
./test_login.sh

# 指定用户名和密码
./test_login.sh admin 123456
```

### 2.3 使用 Postman 或类似工具

1. **请求方法**: POST
2. **URL**: `http://127.0.0.1:8000/v1/login`
3. **Headers**:
   - `Content-Type: application/json`
4. **Body** (raw JSON):
   ```json
   {
     "username": "admin",
     "password": "123456"
   }
   ```

## 三、测试需要认证的接口

登录成功后，使用返回的 `accessToken` 访问需要认证的接口：

```bash
# 获取 Token
TOKEN=$(curl -s -X POST http://127.0.0.1:8000/v1/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}' \
  | jq -r '.data.accessToken')

# 使用 Token 访问需要认证的接口
curl -H "Authorization: Bearer ${TOKEN}" \
  http://127.0.0.1:8000/v1/menus | jq '.'
```

## 四、创建测试用户

如果数据库中没有用户，需要先创建：

### 方式 1: 通过数据库直接创建

```sql
-- 使用 bcrypt 加密密码 "123456"
-- 可以使用在线工具生成: https://bcrypt-generator.com/
-- 或者使用 Go 代码生成

INSERT INTO admin_users (username, nickname, password, email, phone, created_at, updated_at)
VALUES ('admin', '管理员', '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy', 'admin@example.com', '13800138000', NOW(), NOW());
```

### 方式 2: 使用迁移脚本创建

检查 `cmd/migration` 目录中是否有初始化数据的脚本。

### 方式 3: 通过 API 创建（需要先有管理员权限）

如果有其他管理员账号，可以通过 API 创建：
```bash
curl -X POST http://127.0.0.1:8000/v1/admin/user \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456",
    "nickname": "测试用户",
    "email": "test@example.com",
    "phone": "13800138001",
    "roles": []
  }'
```

## 五、测试 LDAP 登录

如果启用了 LDAP，需要：

1. **配置 LDAP**（在 `config/local.yml` 中）:
   ```yaml
   ldap:
     enable: true
     host: 192.168.1.100
     port: 389
     # ... 其他配置
   ```

2. **测试 LDAP 登录**:
   ```bash
   curl -X POST http://127.0.0.1:8000/v1/login \
     -H "Content-Type: application/json" \
     -d '{
       "username": "ldap_user",
       "password": "ldap_password"
     }'
   ```

3. **LDAP 用户首次登录会自动创建本地用户记录**

## 六、常见问题

### 问题 1: 连接被拒绝
```
curl: (7) Failed to connect to 127.0.0.1 port 8000: Connection refused
```
**解决**: 确保服务器已启动

### 问题 2: 401 未授权
```json
{
  "code": 401,
  "message": "登录失效，请重新登录~"
}
```
**解决**: 
- 检查用户名和密码是否正确
- 检查数据库中是否存在该用户
- 检查用户是否被激活（`is_active = true`）

### 问题 3: 500 服务器错误
**解决**: 
- 查看服务器日志
- 检查数据库连接
- 检查配置是否正确

### 问题 4: LDAP 认证失败
**解决**: 
- 检查 LDAP 配置是否正确
- 检查 LDAP 服务器是否可访问
- 查看服务器日志中的 LDAP 错误信息
- LDAP 失败会自动回退到本地认证

## 七、查看 Swagger 文档

启动服务器后，访问 Swagger 文档：
```
http://127.0.0.1:8000/swagger/index.html
```

在 Swagger 中可以：
- 查看所有 API 接口
- 测试登录接口
- 查看请求/响应格式

## 八、调试技巧

### 查看服务器日志
服务器日志会输出到控制台，包含：
- 请求日志
- 错误信息
- LDAP 认证日志

### 使用 verbose 模式
```bash
curl -v -X POST http://127.0.0.1:8000/v1/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'
```

### 检查数据库
```sql
-- 查看所有用户
SELECT * FROM admin_users;

-- 查看用户密码（已加密）
SELECT username, nickname, email, phone, created_at FROM admin_users;
```


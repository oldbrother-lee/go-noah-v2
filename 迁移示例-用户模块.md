# 迁移示例：用户模块（Users Module）

本文档展示如何将 goInsight 的用户模块迁移到 go-noah 框架（最新架构）。

## 一、goInsight 原有结构

### 1.1 目录结构
```
goinsight/internal/users/
├── forms/          # 表单定义
│   ├── users.go
│   ├── roles.go
│   ├── organizations.go
│   └── profile.go
├── models/         # 数据模型
│   └── model.go
├── services/       # 业务逻辑
│   ├── users.go
│   ├── roles.go
│   ├── organizations.go
│   └── profile.go
├── views/          # 视图层（HTTP处理）
│   ├── users.go
│   ├── roles.go
│   ├── organizations.go
│   └── profile.go
└── routers/        # 路由定义
    └── routers.go
```

### 1.2 原有代码示例

**models/model.go:**
```go
type InsightUsers struct {
    Uid         uint64
    Username    string
    Password    string
    Email       string
    NickName    string
    // ...
}
```

**services/users.go:**
```go
type GetUsersService struct {
    C        *gin.Context
    Username string
}

func (s *GetUsersService) Run() {
    var users []models.InsightUsers
    global.App.DB.Find(&users)
    // ...
}
```

**views/users.go:**
```go
func GetUsers(c *gin.Context) {
    service := services.GetUsersService{
        C:        c,
        Username: c.GetString("username"),
    }
    service.Run()
}
```

## 二、go-noah 目标结构

### 2.1 目录结构
```
go-noah/internal/
├── model/
│   └── user.go          # 用户相关模型
├── repository/
│   └── user.go          # 数据访问层
├── service/
│   └── user.go          # 业务逻辑层（全局变量）
└── handler/
    └── user.go          # HTTP处理层（全局变量，空结构体）

go-noah/internal/router/
└── router.go            # 路由注册

go-noah/api/v1/
└── user.go              # API 请求/响应结构体
```

## 三、迁移步骤

### 步骤1：迁移 Model

**go-noah/internal/model/user.go:**
```go
package model

import (
    "time"
    "gorm.io/gorm"
    "gorm.io/datatypes"
)

// User 用户模型
type User struct {
    gorm.Model
    Uid         uint64     `gorm:"type:bigint;primaryKey;autoIncrement;comment:用户ID" json:"uid"`
    Username    string     `gorm:"type:varchar(32);not null;uniqueIndex:uniq_username;comment:用户名" json:"username"`
    Password    string     `gorm:"type:varchar(128);not null;comment:密码" json:"password"`
    Email       string     `gorm:"type:varchar(254);not null;comment:email" json:"email"`
    NickName    string     `gorm:"type:varchar(32);not null;comment:显示名" json:"nick_name"`
    Mobile      string     `gorm:"type:varchar(11);not null;comment:手机号" json:"mobile"`
    AvatarFile  string     `gorm:"type:varchar(254);not null;comment:头像文件地址" json:"avatar_file"`
    RoleID      uint64     `gorm:"type:bigint;null;comment:角色ID" json:"role_id"`
    IsSuperuser bool       `gorm:"type:boolean;default:false;comment:是否为超级管理员" json:"is_superuser"`
    IsActive    bool       `gorm:"type:boolean;default:true;comment:是否激活" json:"is_active"`
    IsStaff     bool       `gorm:"type:boolean;default:false;comment:是否为员工" json:"is_staff"`
    IsTwoFA     bool       `gorm:"type:boolean;default:false;comment:是否启用2FA认证" json:"is_two_fa"`
    OtpSecret   string     `gorm:"type:varchar(128);not null;comment:otp_secret" json:"otp_secret"`
    LastLogin   *time.Time `gorm:"autoUpdateTime;comment:最后一次登录" json:"last_login"`
    DateJoined  *time.Time `gorm:"index:date_joined;autoCreateTime;comment:加入时间" json:"date_joined"`
}

func (User) TableName() string {
    return "insight_users"
}

// Role 角色模型
type Role struct {
    gorm.Model
    Name string `gorm:"type:varchar(32);not null;uniqueIndex:uniq_name;comment:角色名" json:"name"`
}

func (Role) TableName() string {
    return "insight_roles"
}

// Organization 组织架构模型
type Organization struct {
    ID        uint64         `gorm:"primaryKey" json:"id"`
    Name      string         `gorm:"type:varchar(32);not null;uniqueIndex:uniq_name;comment:节点名" json:"name"`
    ParentID  uint64         `gorm:"not null;default 0;uniqueIndex:uniq_name;comment:父节点ID" json:"parent_id"`
    Key       string         `gorm:"type:varchar(256);default null;uniqueIndex:uniq_key;comment:搜索路径" json:"key"`
    Level     uint64         `gorm:"not null;default 1;comment:层级" json:"level"`
    Path      datatypes.JSON `gorm:"type:json;null;default:null;comment:绝对路径" json:"path"`
    CreatedAt time.Time      `gorm:"index:idx_created_at;autoCreateTime" json:"created_at"`
    UpdatedAt time.Time      `gorm:"index:idx_updated_at;autoUpdateTime" json:"updated_at"`
}

func (Organization) TableName() string {
    return "insight_organizations"
}
```

### 步骤2：创建 Repository 层

**go-noah/internal/repository/user.go:**
```go
package repository

import (
    "context"
    "go-noah/internal/model"
    "go-noah/pkg/global"
)

// UserRepository 用户数据访问层
type UserRepository struct {
    *Repository
}

func NewUserRepository(repository *Repository) *UserRepository {
    return &UserRepository{
        Repository: repository,
    }
}

func (r *UserRepository) GetUser(ctx context.Context, id uint64) (*model.User, error) {
    var user model.User
    err := global.DB.WithContext(ctx).Where("uid = ?", id).First(&user).Error
    if err != nil {
        return nil, err
    }
    return &user, nil
}

func (r *UserRepository) GetUserByUsername(ctx context.Context, username string) (*model.User, error) {
    var user model.User
    err := global.DB.WithContext(ctx).Where("username = ?", username).First(&user).Error
    if err != nil {
        return nil, err
    }
    return &user, nil
}

func (r *UserRepository) GetUsers(ctx context.Context, page, pageSize int) ([]*model.User, int64, error) {
    var users []*model.User
    var total int64
    
    offset := (page - 1) * pageSize
    
    // 获取总数
    if err := global.DB.WithContext(ctx).Model(&model.User{}).Count(&total).Error; err != nil {
        return nil, 0, err
    }
    
    // 获取分页数据
    if err := global.DB.WithContext(ctx).
        Offset(offset).
        Limit(pageSize).
        Find(&users).Error; err != nil {
        return nil, 0, err
    }
    
    return users, total, nil
}

func (r *UserRepository) CreateUser(ctx context.Context, user *model.User) error {
    return global.DB.WithContext(ctx).Create(user).Error
}

func (r *UserRepository) UpdateUser(ctx context.Context, user *model.User) error {
    return global.DB.WithContext(ctx).Save(user).Error
}

func (r *UserRepository) DeleteUser(ctx context.Context, id uint64) error {
    return global.DB.WithContext(ctx).Delete(&model.User{}, id).Error
}

// 角色相关方法实现...
// 组织架构相关方法实现...
```

### 步骤3：创建 Service 层（全局变量）

**go-noah/internal/service/user.go:**
```go
package service

import (
    "context"
    "errors"
    "go-noah/api/v1"
    "go-noah/internal/model"
    "go-noah/internal/repository"
    "go-noah/pkg/global"
    "golang.org/x/crypto/bcrypt"
    "gorm.io/gorm"
)

// UserService 用户业务逻辑层
type UserService struct{}

var UserServiceApp = new(UserService)

// getUserRepo 获取 UserRepository（在方法内部创建）
func (s *UserService) getUserRepo() *repository.UserRepository {
    return repository.NewUserRepository(global.Repo)
}

func (s *UserService) GetUser(ctx context.Context, id uint64) (*model.User, error) {
    repo := s.getUserRepo()
    return repo.GetUser(ctx, id)
}

func (s *UserService) GetUsers(ctx context.Context, page, pageSize int) ([]*model.User, int64, error) {
    if page < 1 {
        page = 1
    }
    if pageSize < 1 {
        pageSize = 10
    }
    repo := s.getUserRepo()
    return repo.GetUsers(ctx, page, pageSize)
}

func (s *UserService) CreateUser(ctx context.Context, req *v1.CreateUserRequest) (*model.User, error) {
    repo := s.getUserRepo()
    
    // 检查用户名是否已存在
    existing, _ := repo.GetUserByUsername(ctx, req.Username)
    if existing != nil {
        return nil, errors.New("username already exists")
    }
    
    // 加密密码
    hashedPassword, err := bcrypt.GenerateFromPassword([]byte(req.Password), bcrypt.DefaultCost)
    if err != nil {
        return nil, err
    }
    
    user := &model.User{
        Username:   req.Username,
        Password:   string(hashedPassword),
        Email:      req.Email,
        NickName:   req.NickName,
        Mobile:     req.Mobile,
        RoleID:     req.RoleID,
        IsActive:   true,
        IsTwoFA:    false,
        AvatarFile: "/static/avatar2.jpg",
    }
    
    if err := repo.CreateUser(ctx, user); err != nil {
        return nil, err
    }
    
    return user, nil
}

func (s *UserService) UpdateUser(ctx context.Context, id uint64, req *v1.UpdateUserRequest) error {
    repo := s.getUserRepo()
    user, err := repo.GetUser(ctx, id)
    if err != nil {
        return err
    }
    
    if req.Email != "" {
        user.Email = req.Email
    }
    if req.NickName != "" {
        user.NickName = req.NickName
    }
    if req.Mobile != "" {
        user.Mobile = req.Mobile
    }
    if req.RoleID > 0 {
        user.RoleID = req.RoleID
    }
    user.IsActive = req.IsActive
    
    return repo.UpdateUser(ctx, user)
}

func (s *UserService) DeleteUser(ctx context.Context, id uint64) error {
    repo := s.getUserRepo()
    return repo.DeleteUser(ctx, id)
}

func (s *UserService) Login(ctx context.Context, username, password string) (*model.User, string, error) {
    repo := s.getUserRepo()
    user, err := repo.GetUserByUsername(ctx, username)
    if err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, "", errors.New("invalid username or password")
        }
        return nil, "", err
    }
    
    // 验证密码
    if err := bcrypt.CompareHashAndPassword([]byte(user.Password), []byte(password)); err != nil {
        return nil, "", errors.New("invalid username or password")
    }
    
    if !user.IsActive {
        return nil, "", errors.New("user is not active")
    }
    
    // 生成 JWT Token
    token, err := global.JWT.GenToken(user.Uid, time.Now().Add(time.Hour*24*90))
    if err != nil {
        return nil, "", err
    }
    
    return user, token, nil
}
```

### 步骤4：创建 API 请求/响应结构体

**go-noah/api/v1/user.go:**
```go
package v1

// CreateUserRequest 创建用户请求
type CreateUserRequest struct {
    Username string `json:"username" binding:"required"`
    Password string `json:"password" binding:"required"`
    Email    string `json:"email" binding:"required,email"`
    NickName string `json:"nick_name" binding:"required"`
    Mobile   string `json:"mobile"`
    RoleID   uint64 `json:"role_id"`
}

// UpdateUserRequest 更新用户请求
type UpdateUserRequest struct {
    Email    string `json:"email"`
    NickName string `json:"nick_name"`
    Mobile   string `json:"mobile"`
    RoleID   uint64 `json:"role_id"`
    IsActive bool   `json:"is_active"`
}

// GetUsersRequest 获取用户列表请求
type GetUsersRequest struct {
    Page     int `form:"page" json:"page"`
    PageSize int `form:"page_size" json:"page_size"`
}

// GetUsersResponseData 获取用户列表响应数据
type GetUsersResponseData struct {
    List  []*UserData `json:"list"`
    Total int64       `json:"total"`
}

// UserData 用户数据
type UserData struct {
    Uid        uint64 `json:"uid"`
    Username   string `json:"username"`
    Email      string `json:"email"`
    NickName   string `json:"nick_name"`
    Mobile     string `json:"mobile"`
    AvatarFile string `json:"avatar_file"`
    RoleID     uint64 `json:"role_id"`
    IsActive   bool   `json:"is_active"`
    CreatedAt  string `json:"created_at"`
    UpdatedAt  string `json:"updated_at"`
}
```

### 步骤5：创建 Handler 层（全局变量，空结构体）

**go-noah/internal/handler/user.go:**
```go
package handler

import (
    "go-noah/api/v1"
    "go-noah/internal/service"
    "net/http"
    "strconv"
    
    "github.com/gin-gonic/gin"
)

// UserHandler 用户 Handler
type UserHandler struct{}

// UserHandlerApp 全局 Handler 实例
var UserHandlerApp = new(UserHandler)

// GetUsers 获取用户列表
// @Summary 获取用户列表
// @Description 分页获取用户列表
// @Tags 用户管理
// @Accept json
// @Produce json
// @Param page query int false "页码" default(1)
// @Param page_size query int false "每页数量" default(10)
// @Success 200 {object} v1.Response{data=v1.GetUsersResponseData}
// @Router /v1/users [get]
func (h *UserHandler) GetUsers(ctx *gin.Context) {
    page, _ := strconv.Atoi(ctx.DefaultQuery("page", "1"))
    pageSize, _ := strconv.Atoi(ctx.DefaultQuery("page_size", "10"))
    
    users, total, err := service.UserServiceApp.GetUsers(ctx.Request.Context(), page, pageSize)
    if err != nil {
        v1.HandleError(ctx, http.StatusInternalServerError, v1.ErrInternalServerError, nil)
        return
    }
    
    // 转换为响应格式
    list := make([]v1.UserData, 0, len(users))
    for _, user := range users {
        list = append(list, v1.UserData{
            Uid:        user.Uid,
            Username:   user.Username,
            Email:      user.Email,
            NickName:   user.NickName,
            Mobile:     user.Mobile,
            AvatarFile: user.AvatarFile,
            RoleID:     user.RoleID,
            IsActive:   user.IsActive,
            CreatedAt:  user.CreatedAt.Format("2006-01-02 15:04:05"),
            UpdatedAt:  user.UpdatedAt.Format("2006-01-02 15:04:05"),
        })
    }
    
    v1.HandleSuccess(ctx, v1.GetUsersResponseData{
        List:  list,
        Total: total,
    })
}

// GetUser 获取用户详情
// @Summary 获取用户详情
// @Description 根据ID获取用户详情
// @Tags 用户管理
// @Accept json
// @Produce json
// @Param id path int true "用户ID"
// @Success 200 {object} v1.Response{data=v1.UserData}
// @Router /v1/users/:id [get]
func (h *UserHandler) GetUser(ctx *gin.Context) {
    id, err := strconv.ParseUint(ctx.Param("id"), 10, 64)
    if err != nil {
        v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, nil)
        return
    }
    
    user, err := service.UserServiceApp.GetUser(ctx.Request.Context(), id)
    if err != nil {
        v1.HandleError(ctx, http.StatusInternalServerError, v1.ErrInternalServerError, nil)
        return
    }
    
    v1.HandleSuccess(ctx, v1.UserData{
        Uid:        user.Uid,
        Username:   user.Username,
        Email:      user.Email,
        NickName:   user.NickName,
        Mobile:     user.Mobile,
        AvatarFile: user.AvatarFile,
        RoleID:     user.RoleID,
        IsActive:   user.IsActive,
        CreatedAt:  user.CreatedAt.Format("2006-01-02 15:04:05"),
        UpdatedAt:  user.UpdatedAt.Format("2006-01-02 15:04:05"),
    })
}

// CreateUser 创建用户
// @Summary 创建用户
// @Description 创建新用户
// @Tags 用户管理
// @Accept json
// @Produce json
// @Param user body v1.CreateUserRequest true "用户信息"
// @Success 200 {object} v1.Response{data=v1.UserData}
// @Router /v1/users [post]
func (h *UserHandler) CreateUser(ctx *gin.Context) {
    var req v1.CreateUserRequest
    if err := ctx.ShouldBindJSON(&req); err != nil {
        v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, nil)
        return
    }
    
    user, err := service.UserServiceApp.CreateUser(ctx.Request.Context(), &req)
    if err != nil {
        v1.HandleError(ctx, http.StatusInternalServerError, v1.ErrInternalServerError, nil)
        return
    }
    
    v1.HandleSuccess(ctx, v1.UserData{
        Uid:        user.Uid,
        Username:   user.Username,
        Email:      user.Email,
        NickName:   user.NickName,
        Mobile:     user.Mobile,
        AvatarFile: user.AvatarFile,
        RoleID:     user.RoleID,
        IsActive:   user.IsActive,
        CreatedAt:  user.CreatedAt.Format("2006-01-02 15:04:05"),
        UpdatedAt:  user.UpdatedAt.Format("2006-01-02 15:04:05"),
    })
}

// UpdateUser 更新用户
// @Summary 更新用户
// @Description 更新用户信息
// @Tags 用户管理
// @Accept json
// @Produce json
// @Param id path int true "用户ID"
// @Param user body v1.UpdateUserRequest true "用户信息"
// @Success 200 {object} v1.Response
// @Router /v1/users/:id [put]
func (h *UserHandler) UpdateUser(ctx *gin.Context) {
    id, err := strconv.ParseUint(ctx.Param("id"), 10, 64)
    if err != nil {
        v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, nil)
        return
    }
    
    var req v1.UpdateUserRequest
    if err := ctx.ShouldBindJSON(&req); err != nil {
        v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, nil)
        return
    }
    
    if err := service.UserServiceApp.UpdateUser(ctx.Request.Context(), id, &req); err != nil {
        v1.HandleError(ctx, http.StatusInternalServerError, v1.ErrInternalServerError, nil)
        return
    }
    
    v1.HandleSuccess(ctx, nil)
}

// DeleteUser 删除用户
// @Summary 删除用户
// @Description 删除用户
// @Tags 用户管理
// @Accept json
// @Produce json
// @Param id path int true "用户ID"
// @Success 200 {object} v1.Response
// @Router /v1/users/:id [delete]
func (h *UserHandler) DeleteUser(ctx *gin.Context) {
    id, err := strconv.ParseUint(ctx.Param("id"), 10, 64)
    if err != nil {
        v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, nil)
        return
    }
    
    if err := service.UserServiceApp.DeleteUser(ctx.Request.Context(), id); err != nil {
        v1.HandleError(ctx, http.StatusInternalServerError, v1.ErrInternalServerError, nil)
        return
    }
    
    v1.HandleSuccess(ctx, nil)
}
```

### 步骤6：在 router 中注册路由

**go-noah/internal/router/router.go:**
```go
// 在 InitRouter 函数中添加
func InitRouter(r *gin.Engine, jwt *jwt.JWT, e *casbin.SyncedEnforcer, logger *log.Logger) {
    InitAdminRouter(r, jwt, e, logger)
    InitUserRouter(r, jwt, e, logger)  // 添加用户路由
}

// InitUserRouter 初始化用户相关路由
func InitUserRouter(r *gin.Engine, jwt *jwt.JWT, e *casbin.SyncedEnforcer, logger *log.Logger) {
    v1 := r.Group("/v1")
    {
        // Strict permission routing group
        strictAuthRouter := v1.Group("/").Use(middleware.StrictAuth(jwt, logger), middleware.AuthMiddleware(e))
        {
            // 用户管理路由
            strictAuthRouter.GET("/users", handler.UserHandlerApp.GetUsers)
            strictAuthRouter.GET("/users/:id", handler.UserHandlerApp.GetUser)
            strictAuthRouter.POST("/users", handler.UserHandlerApp.CreateUser)
            strictAuthRouter.PUT("/users/:id", handler.UserHandlerApp.UpdateUser)
            strictAuthRouter.DELETE("/users/:id", handler.UserHandlerApp.DeleteUser)
        }
    }
}
```

## 四、关键差异总结

| 方面 | goInsight | go-noah（最新架构） |
|------|-----------|---------------------|
| **数据访问** | `global.App.DB` | `global.DB`（在 Repository 中） |
| **业务逻辑** | `services.GetUsersService.Run()` | `service.UserServiceApp.GetUsers()`（全局变量） |
| **HTTP处理** | `views.GetUsers(c)` | `handler.UserHandlerApp.GetUsers(ctx)`（全局变量） |
| **依赖管理** | 全局变量 `global.App` | 全局变量 `global.*` + 全局 Service/Handler |
| **错误处理** | 自定义响应 | `v1.HandleError/HandleSuccess` |
| **参数验证** | 手动验证 | `ShouldBindJSON` |
| **路由注册** | `routers/routers.go` | `internal/router/router.go` |
| **Service 定义** | 结构体，需要实例化 | 空结构体，全局变量 |
| **Handler 定义** | 函数 | 空结构体，全局变量 |

## 五、迁移检查清单

- [ ] Model 已迁移并包含所有字段
- [ ] Repository 结构体已定义并实现（不需要接口）
- [ ] Service 层已实现所有业务逻辑（全局变量）
- [ ] Handler 层已实现所有 HTTP 处理（全局变量，空结构体）
- [ ] API 请求/响应结构体已定义
- [ ] 路由已在 `internal/router/` 中注册并配置权限
- [ ] Swagger 注释已添加
- [ ] 单元测试已编写
- [ ] API 测试通过

## 六、注意事项

1. **Service 和 Handler 都是全局变量**：不需要在 `noah.go` 中创建实例
2. **Repository 在方法内部创建**：Service 方法中通过 `getUserRepo()` 创建 Repository
3. **使用 global 包**：基础设施（DB、Logger、JWT等）都存储在 `global` 包中
4. **路由在 router 包中注册**：所有路由集中在 `internal/router/router.go` 中

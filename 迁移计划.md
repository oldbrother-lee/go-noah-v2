# goInsight 迁移到 go-noah 框架迁移计划

## 一、项目对比分析

### 1.1 架构差异

| 维度 | goInsight | go-noah |
|------|-----------|---------|
| **依赖管理** | 全局变量 `global.App` | 全局变量 `global.*` + 全局 Service/Handler |
| **分层架构** | Views -> Services -> DAO | Handler -> Service -> Repository -> Model |
| **权限控制** | 简单中间件 | Casbin RBAC |
| **日志系统** | Logrus | Zap |
| **配置管理** | Viper (YAML) | Viper (YAML) |
| **前端框架** | SoybeanAdmin (NaiveUI) | AntdvPro (Ant Design Vue) |
| **数据库迁移** | 启动时 AutoMigrate | 独立的 migration 命令 |

### 1.2 功能模块映射

| goInsight 模块 | 迁移后位置 | 说明 |
|---------------|-----------|------|
| `internal/users` | `internal/handler/user.go`<br>`internal/service/user.go`<br>`internal/repository/user.go`<br>`internal/model/user.go` | 用户管理模块 |
| `internal/orders` | `internal/handler/order.go`<br>`internal/service/order.go`<br>`internal/repository/order.go`<br>`internal/model/order.go` | 工单管理模块 |
| `internal/das` | `internal/handler/das.go`<br>`internal/service/das.go`<br>`internal/repository/das.go`<br>`internal/model/das.go` | 数据查询服务 |
| `internal/inspect` | `internal/handler/inspect.go`<br>`internal/service/inspect.go`<br>`internal/repository/inspect.go`<br>`internal/model/inspect.go` | SQL审核模块 |
| `internal/common` | `internal/handler/common.go`<br>`internal/service/common.go`<br>`internal/repository/common.go`<br>`internal/model/common.go` | 通用功能模块 |

## 二、迁移步骤

### 阶段一：基础架构迁移（1-2周）

#### 1.1 项目结构初始化
- [ ] 在 go-noah 中创建新的业务模块目录结构
- [ ] 配置迁移：将 `goInsight/config.yaml` 转换为 `go-noah/config/local.yml` 格式
- [ ] 日志系统迁移：Logrus -> Zap
- [ ] 数据库连接迁移：从 `global.App.DB` 迁移到 `global.DB`

#### 1.2 全局变量重构
- [ ] 移除所有 `global.App` 引用
- [ ] 在 `pkg/noah/noah.go` 中初始化基础设施到 `global` 包
- [ ] Service 和 Handler 改为全局变量（不需要依赖注入）

#### 1.3 中间件迁移
- [ ] JWT 中间件：从 `middleware/jwt.go` 迁移到 go-noah 的 JWT 中间件
- [ ] 权限中间件：从简单权限检查迁移到 Casbin RBAC
- [ ] 日志中间件：迁移请求日志记录
- [ ] CORS 中间件：保持现有配置

### 阶段二：数据模型迁移（1周）

#### 2.1 Model 迁移
- [ ] 迁移所有 Model 定义到 `internal/model/`
- [ ] 统一使用 `gorm.Model` 或自定义 BaseModel
- [ ] 处理枚举类型（EnumType）迁移
- [ ] 处理 UUID 类型字段

#### 2.2 Repository 层实现
- [ ] 为每个模块创建 Repository 结构体（不需要接口）
- [ ] 迁移 DAO 层逻辑到 Repository
- [ ] 实现事务管理（Transaction）

#### 2.3 数据库迁移
- [ ] 创建 migration 脚本（`cmd/migration/`）
- [ ] 迁移表结构定义
- [ ] 迁移初始化数据（管理员用户、默认配置等）

### 阶段三：业务逻辑迁移（2-3周）

#### 3.1 用户管理模块（users）
- [ ] 迁移用户 CRUD 操作
- [ ] 迁移角色管理
- [ ] 迁移组织架构管理
- [ ] 迁移 2FA 认证逻辑
- [ ] 迁移 LDAP 集成（如需要）

#### 3.2 工单管理模块（orders）
- [ ] 迁移工单创建、审核、执行流程
- [ ] 迁移工单任务调度（Scheduler）
- [ ] 迁移 WebSocket 实时通信
- [ ] 迁移消息通知（企业微信、钉钉、邮件）
- [ ] 迁移工单操作日志

#### 3.3 数据查询服务（das）
- [ ] 迁移 SQL 查询执行逻辑
- [ ] 迁移查询权限控制
- [ ] 迁移 SQL 重写和优化
- [ ] 迁移查询历史记录
- [ ] 迁移收藏功能
- [ ] 支持 MySQL、ClickHouse、TiDB

#### 3.4 SQL审核模块（inspect）
- [ ] 迁移 SQL 语法检查
- [ ] 迁移规则引擎
- [ ] 迁移审核参数配置
- [ ] 迁移表结构分析

#### 3.5 通用功能模块（common）
- [ ] 迁移数据库配置管理
- [ ] 迁移环境管理
- [ ] 迁移定时任务（Cron）

### 阶段四：Service 层重构（1-2周）

#### 4.1 Service 实现
- [ ] 为每个模块创建 Service 结构体（全局变量）
- [ ] 实现业务逻辑
- [ ] 处理事务（使用 `global.Transaction`）

#### 4.2 Handler 层实现
- [ ] 迁移 Views 层到 Handler 层（空结构体，全局变量）
- [ ] 实现请求参数验证
- [ ] 实现响应格式化
- [ ] 添加 Swagger 注释

### 阶段五：路由和API迁移（1周）

#### 5.1 路由配置
- [ ] 在 `internal/router/` 中创建路由注册函数
- [ ] 配置权限策略（Casbin）
- [ ] 配置路由分组和中间件

#### 5.2 API 兼容性
- [ ] 保持 API 路径兼容（如需要）
- [ ] 统一响应格式
- [ ] 添加 API 版本控制（v1）

### 阶段六：定时任务和后台任务（1周）

#### 6.1 Job 迁移
- [ ] 迁移定时任务到 `internal/job/`
- [ ] 配置 Job Server
- [ ] 迁移元数据同步任务

#### 6.2 Task 迁移
- [ ] 迁移后台任务到 `internal/task/`
- [ ] 配置 Task Server

### 阶段七：前端适配（2-3周）

#### 7.1 API 接口适配
- [ ] 更新前端 API 调用路径
- [ ] 适配新的响应格式
- [ ] 处理权限路由

#### 7.2 UI 组件迁移（可选）
- [ ] 评估是否需要从 NaiveUI 迁移到 Ant Design Vue
- [ ] 如需要，迁移关键组件
- [ ] 保持现有功能不变

### 阶段八：测试和优化（1-2周）

#### 8.1 单元测试
- [ ] 为 Repository 层添加测试
- [ ] 为 Service 层添加测试
- [ ] 为 Handler 层添加测试

#### 8.2 集成测试
- [ ] 测试完整业务流程
- [ ] 测试权限控制
- [ ] 测试并发场景

#### 8.3 性能优化
- [ ] 数据库查询优化
- [ ] 缓存策略优化
- [ ] 接口响应时间优化

## 三、关键技术点

### 3.1 全局变量模式转换

**goInsight 模式：**
```go
// 使用全局变量
global.App.DB.Create(&user)
global.App.Redis.Set(ctx, key, value, 0)
```

**go-noah 模式：**
```go
// 使用全局变量（基础设施）
global.DB.Create(&user)
global.Logger.Info("message")

// Service 和 Handler 也是全局变量
service.UserServiceApp.GetUser(ctx, id)
handler.UserHandlerApp.GetUsers(ctx)
```

### 3.2 Service 和 Handler 定义

**go-noah 模式：**
```go
// Service 层
type UserService struct{}

var UserServiceApp = new(UserService)

func (s *UserService) GetUser(ctx context.Context, id uint64) (*model.User, error) {
    repo := repository.NewUserRepository(global.Repo)
    return repo.GetUser(ctx, id)
}

// Handler 层
type UserHandler struct{}

var UserHandlerApp = new(UserHandler)

func (h *UserHandler) GetUsers(ctx *gin.Context) {
    users, total, err := service.UserServiceApp.GetUsers(ctx.Request.Context(), page, pageSize)
    v1.HandleSuccess(ctx, gin.H{"list": users, "total": total})
}
```

### 3.3 权限控制迁移

**goInsight 模式：**
```go
// 简单权限检查
if !user.IsSuperuser {
    return errors.New("permission denied")
}
```

**go-noah 模式：**
```go
// Casbin RBAC
strictAuthRouter := v1.Group("/").Use(
    middleware.StrictAuth(jwt, logger), 
    middleware.AuthMiddleware(e),
)
```

### 3.4 配置管理迁移

**goInsight 配置：**
```yaml
app:
  listen_address: "localhost:8083"
database:
  host: "127.0.0.1"
  port: 3306
```

**go-noah 配置：**
```yaml
http:
  host: 127.0.0.1
  port: 8000
data:
  db:
    user:
      driver: mysql
      dsn: root:password@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4
```

### 3.5 日志系统迁移

**goInsight：**
```go
global.App.Log.Info("message")
global.App.Log.Error("error", err)
```

**go-noah：**
```go
global.Logger.Info("message", zap.String("key", "value"))
global.Logger.Error("error", zap.Error(err))
```

## 四、迁移优先级

### 高优先级（核心功能）
1. ✅ 用户认证和授权
2. ✅ 数据库连接和模型
3. ✅ 工单管理核心流程
4. ✅ 数据查询服务

### 中优先级（重要功能）
1. ✅ SQL审核功能
2. ✅ 消息通知
3. ✅ 定时任务
4. ✅ WebSocket 实时通信

### 低优先级（辅助功能）
1. ✅ 前端UI迁移（如需要）
2. ✅ 性能监控
3. ✅ 文档完善

## 五、风险评估和应对

### 5.1 技术风险
- **风险**：全局变量可能导致测试困难
- **应对**：在测试时可以通过修改 `global` 包中的变量来注入 mock 对象

- **风险**：权限系统迁移可能导致权限丢失
- **应对**：详细记录现有权限规则，迁移后全面测试

### 5.2 业务风险
- **风险**：迁移期间服务中断
- **应对**：采用灰度迁移，保持旧系统运行

- **风险**：数据迁移丢失
- **应对**：完整备份，迁移前后数据校验

## 六、迁移检查清单

### 代码层面
- [ ] 所有 `global.App` 引用已移除
- [ ] 所有模块已实现 Repository、Service、Handler 三层
- [ ] Service 和 Handler 已定义为全局变量
- [ ] 所有路由已在 `internal/router/` 中注册并配置权限
- [ ] 所有 Model 已迁移并创建 migration
- [ ] 日志系统已统一使用 Zap
- [ ] 配置已迁移到新格式

### 功能层面
- [ ] 用户登录、注册功能正常
- [ ] 权限控制正常工作
- [ ] 工单流程完整可用
- [ ] 数据查询功能正常
- [ ] SQL审核功能正常
- [ ] 消息通知正常
- [ ] 定时任务正常执行

### 测试层面
- [ ] 单元测试覆盖率 > 60%
- [ ] 集成测试通过
- [ ] 性能测试达标
- [ ] 安全测试通过

## 七、迁移时间估算

| 阶段 | 预计时间 | 人员需求 |
|------|---------|---------|
| 阶段一：基础架构迁移 | 1-2周 | 1-2人 |
| 阶段二：数据模型迁移 | 1周 | 1人 |
| 阶段三：业务逻辑迁移 | 2-3周 | 2-3人 |
| 阶段四：Service层重构 | 1-2周 | 1-2人 |
| 阶段五：路由和API迁移 | 1周 | 1人 |
| 阶段六：定时任务迁移 | 1周 | 1人 |
| 阶段七：前端适配 | 2-3周 | 1-2人 |
| 阶段八：测试和优化 | 1-2周 | 2人 |
| **总计** | **10-15周** | **2-3人** |

## 八、后续优化建议

1. **代码质量**
   - 添加更多单元测试
   - 使用代码质量工具（golangci-lint）
   - 建立代码审查流程

2. **性能优化**
   - 数据库查询优化
   - 缓存策略优化
   - 接口响应时间监控

3. **功能增强**
   - 完善权限管理（Casbin 策略可视化）
   - 添加操作审计日志
   - 支持更多数据库类型

4. **运维支持**
   - 添加 Prometheus 监控
   - 添加 Grafana 仪表盘
   - 容器化部署（Docker/K8s）
